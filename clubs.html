<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clubs - Chat.me</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <!-- Montserrat Font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <!-- jQuery Slim -->
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-light: #e0e5ec;
            --bg-dark: #2c3e50;
            --bg-color: #e0e5ec;
            --neumorph-shadow: 8px 8px 16px #a3b1c6, -8px -8px 16px #ffffff;
            --neumorph-inset: inset 4px 4px 8px #a3b1c6, inset -4px -4px 8px #ffffff;
            --text-color: #333;
            --accent-color: #4a90e2;
            --error-color: #dc3545;
            --success-color: #28a745;
            --text-muted: #6c757d;
            --table-highlight: #d1e7ff;
            --premium-color: #FFD700;
        }

        body {
            background: var(--bg-color);
            font-family: 'Montserrat', sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body.dark-theme {
            --bg-color: #2c3e50;
            --neumorph-shadow: 8px 8px 16px #1a252f, -8px -8px 16px #3e5a75;
            --neumorph-inset: inset 4px 4px 8px #1a252f, inset -4px -4px 8px #3e5a75;
            --text-color: #ecf0f1;
            --accent-color: #3498db;
            --table-highlight: #2a4d69;
        }

        .neumorphic-btn {
            background: var(--bg-color);
            border: none;
            border-radius: 12px;
            box-shadow: var(--neumorph-shadow);
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--text-color);
            transition: all 0.2s ease;
        }

        .neumorphic-btn:hover {
            box-shadow: var(--neumorph-inset);
            transform: translateY(1px);
        }

        .neumorphic-btn:active {
            box-shadow: var(--neumorph-inset);
            transform: translateY(2px);
        }

        .neumorphic-btn.primary {
            background: var(--accent-color);
            color: #fff;
        }

        .neumorphic-btn.premium {
            background: var(--premium-color);
            color: #333;
        }

        /* Navigation Bar */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-color);
            box-shadow: var(--neumorph-shadow);
            padding: 10px 20px;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-right {
            display: flex;
            align-items: center;
        }

        .club-list-toggle {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            box-shadow: var(--neumorph-shadow);
            transition: transform 0.3s ease;
        }

        .club-list-toggle.active {
            transform: rotate(180deg);
        }

        .club-list {
            position: absolute;
            top: 60px;
            left: 20px;
            width: 250px;
            background: var(--bg-color);
            box-shadow: var(--neumorph-shadow);
            border-radius: 12px;
            padding: 20px;
            display: none;
            z-index: 999;
            max-height: 70vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease;
        }

        .club-list.show {
            display: block;
        }

        .club-group h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-color);
        }

        .club-item {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: var(--neumorph-shadow);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .club-item.selected {
            background: var(--accent-color);
            color: #fff;
            box-shadow: var(--neumorph-inset);
        }

        .club-item img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .club-item div {
            flex: 1;
        }

        .club-item h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            color: var(--text-color);
        }

        .club-item p {
            font-size: 12px;
            color: var(--text-muted);
            margin: 4px 0 0;
        }

        /* No Clubs State */
        .no-clubs {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 60px);
            text-align: center;
            padding: 20px;
        }

        .no-clubs h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        /* Top Section */
        .top-section {
            background: var(--bg-color);
            box-shadow: var(--neumorph-shadow);
            padding: 20px;
            text-align: center;
            display: none;
        }

        .club-banner {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: var(--neumorph-inset);
            margin-bottom: 20px;
        }

        .club-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .club-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: var(--neumorph-shadow);
        }

        .club-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: var(--text-color);
        }

        .club-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-color);
            box-shadow: var(--neumorph-shadow);
            border-radius: 8px;
            padding: 10px;
            z-index: 1001;
        }

        .dropdown.active .dropdown-content {
            display: block;
        }

        .dropdown-content div {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
        }

        .dropdown-content div:hover {
            background: var(--accent-color);
            color: #fff;
            border-radius: 6px;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            display: none;
        }

        /* Chat Section */
        .chat-section {
            flex: 2;
            background: var(--bg-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--neumorph-shadow);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            box-shadow: var(--neumorph-inset);
        }

        .chat-message {
            position: relative;
            background: var(--bg-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: var(--neumorph-shadow);
            max-width: 70%;
            word-wrap: break-word;
        }

        .chat-message.own {
            margin-left: auto;
            background: var(--accent-color);
            color: #fff;
        }

        .chat-message img, .chat-message video {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: var(--neumorph-shadow);
            margin-top: 5px;
        }

        .chat-message .sender {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .chat-message .message-menu {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            color: var(--text-color);
        }

        .chat-message:hover .message-menu {
            display: block;
        }

        .chat-message.own .message-menu {
            color: #fff;
        }

        .message-menu-content {
            display: none;
            position: absolute;
            top: 25px;
            right: 0;
            background: var(--bg-color);
            box-shadow: var(--neumorph-shadow);
            border-radius: 8px;
            padding: 10px;
            z-index: 1001;
        }

        .message-menu-content.active {
            display: block;
        }

        .message-menu-content div {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
        }

        .message-menu-content div:hover {
            background: var(--accent-color);
            color: #fff;
            border-radius: 6px;
        }

        .chat-message.pinned {
            border-left: 4px solid var(--accent-color);
            background: var(--table-highlight);
        }

        .pinned-icon {
            position: absolute;
            top: 5px;
            left: 5px;
            color: var(--accent-color);
        }

        .reactions {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .read-receipt {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .timestamp {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
            text-align: right;
        }

        .mention {
            color: var(--accent-color);
            cursor: pointer;
            font-weight: 600;
        }

        .mention:hover {
            text-decoration: underline;
        }

        .chat-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-form input[type="text"] {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            box-shadow: var(--neumorph-inset);
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .chat-form input[type="file"] {
            display: none;
        }

        /* Club Info Section */
        .club-info-section {
            flex: 1;
            background: var(--table-highlight);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--neumorph-shadow);
        }

        .club-info-section img {
            border-radius: 4px;
            max-width: 100%;
            margin-bottom: 15px;
        }

        .club-info-section h2 {
            margin: 0 0 10px;
            font-size: 20px;
            color: var(--text-color);
        }

        .club-info-section p {
            margin: 5px 0;
            color: var(--text-muted);
        }

        .club-info-section .membership-status {
            font-weight: bold;
            color: var(--accent-color);
        }

        .club-info-section .loading {
            text-align: center;
            font-style: italic;
            color: var(--text-muted);
        }

        .club-info-section .error {
            color: var(--error-color);
            text-align: center;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 640px;
            max-width: 90%;
            min-height: 400px;
            background: var(--bg-color);
            border: none;
            border-radius: 16px;
            box-shadow: var(--neumorph-shadow);
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            flex-direction: column;
            animation: slideUp 0.3s ease;
            tabindex="0";
        }

        .modal.active {
            display: flex;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            padding: 16px 24px;
            background: var(--accent-color);
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
        }

        .modal-content {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
            max-height: 600px;
            background: var(--bg-color);
            box-shadow: var(--neumorph-inset);
            border-radius: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: var(--text-color);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            box-shadow: var(--neumorph-inset);
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.1), inset -2px -2px 4px rgba(255, 255, 255, 0.7), 0 0 0 3px var(--accent-color);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .error {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .modal-progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .modal-progress span {
            width: 10px;
            height: 10px;
            background: var(--text-muted);
            border-radius: 50%;
        }

        .modal-progress span.active {
            background: var(--accent-color);
        }

        /* Topic Filter */
        .topic-filter {
            margin-bottom: 20px;
        }

        .topic-category {
            margin-bottom: 15px;
        }

        .topic-item {
            padding: 8px;
            border-radius: 8px;
            box-shadow: var(--neumorph-shadow);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .topic-item.selected {
            background: var(--accent-color);
            color: #fff;
        }

        .topic-item:hover {
            box-shadow: var(--neumorph-inset);
        }

        /* Image Preview */
        .preview-image {
            max-width: 100%;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: var(--neumorph-shadow);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 12px;
            color: #fff;
            z-index: 1001;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translate(-50%, -40%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .chat-section,
            .club-info-section {
                flex: none;
                width: 100%;
            }
            .club-list {
                width: 100%;
                left: 0;
                top: 70px;
            }
            .modal {
                width: 90%;
                min-width: 300px;
            }
            .chat-message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-left">
            <button class="neumorphic-btn" onclick="window.location.href='/main.html'" aria-label="Back to Main">Back to Main</button>
            <button class="neumorphic-btn" onclick="window.location.href='/settings.html'" aria-label="Settings">Settings</button>
            <button class="neumorphic-btn" onclick="window.location.href='/chat.html'" aria-label="Switch to Chat">Switch to Chat</button>
            <span id="club-list-toggle" class="club-list-toggle" aria-label="Toggle club list"><i class="fas fa-chevron-down"></i></span>
            <div id="club-list" class="club-list">
                <div id="club-list-empty" class="club-list-empty">
                    <p>No clubs yet. Create one!</p>
                </div>
                <div id="my-clubs" class="club-group">
                    <h3>My Clubs</h3>
                    <div id="my-clubs-list"></div>
                </div>
                <div id="joined-clubs" class="club-group">
                    <h3>Joined Clubs</h3>
                    <div id="joined-clubs-list"></div>
                </div>
                <div id="available-clubs" class="club-group">
                    <h3>Available Clubs</h3>
                    <div id="available-clubs-list"></div>
                </div>
            </div>
        </div>
        <div class="nav-right">
            <button id="create-club-nav-btn" class="neumorphic-btn primary" aria-label="Create a Club"><i class="fas fa-plus"></i> Create a Club</button>
        </div>
    </div>

    <!-- No Clubs State -->
    <div id="no-clubs" class="no-clubs">
        <h2>No Clubs Yet</h2>
        <button id="create-club-no-club-btn" class="neumorphic-btn primary" aria-label="Create a Club">Create a Club</button>
    </div>

    <!-- Top Section -->
    <div id="top-section" class="top-section">
        <img id="club-top-img" class="club-banner" src="/assets/default-banner.jpg" alt="Club Banner">
        <div class="club-header">
            <img id="club-photo" class="club-photo" src="/assets/default-club-image.jpg" alt="Club Image">
            <h1 id="club-title">Club Name</h1>
        </div>
        <div class="club-actions">
            <button id="notifications-btn" class="neumorphic-btn" aria-label="Notifications"><i class="fas fa-bell"></i> Notifications</button>
            <button id="join-club-btn" class="neumorphic-btn primary" aria-label="Join Club" style="display: none;"><i class="fas fa-user-plus"></i> Join</button>
            <div class="dropdown">
                <button id="more-options-btn" class="neumorphic-btn" aria-label="More options"><i class="fas fa-ellipsis"></i></button>
                <div class="dropdown-content">
                    <div onclick="addToFavorites()">Add to Favorites</div>
                    <div onclick="muteClub()">Mute Club</div>
                    <div id="delete-club-option" onclick="deleteClub()" style="display: none;">Delete Club</div>
                    <div onclick="openModdingTools()">Modding Tools</div>
                    <div onclick="copyInviteLink()">Copy Invite Link</div>
                    <div onclick="openClubSettings()">Club Settings</div>
                    <div onclick="toggleTheme()">Toggle Theme</div>
                    <div onclick="logout()">Logout</div>
                </div>
            </div>
            <button id="create-post-btn" class="neumorphic-btn primary" aria-label="Create a Post">Create a Post</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="main-content">
        <!-- Chat Section -->
        <div id="chat-section" class="chat-section">
            <h2>Club Chat</h2>
            <div id="chat-messages" class="chat-messages">
                <p class="text-center" style="color: var(--text-muted);">No messages yet. Start the conversation!</p>
            </div>
            <div class="chat-form">
                <input type="text" id="chat-input-text" placeholder="Type a message..." aria-label="Type a message">
                <input type="file" id="chat-media-input" accept="image/*,video/*" aria-label="Upload media">
                <button id="upload-media-btn" class="neumorphic-btn" aria-label="Upload media"><i class="fas fa-image"></i></button>
                <button id="send-message-btn" class="neumorphic-btn primary" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- Club Info Section -->
        <div id="club-info-section" class="club-info-section loading">
            Loading club info...
        </div>
    </div>

    <!-- Create Club Modal -->
    <div id="create-club-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title-club">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title-club">Create a Club</h3>
                <button class="neumorphic-btn" aria-label="Close modal" onclick="modalToggle('create-club-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <div class="modal-progress">
                    <span class="progress-step-club active"></span>
                    <span class="progress-step-club"></span>
                    <span class="progress-step-club"></span>
                    <span class="progress-step-club"></span>
                </div>
                <form id="create-club-form">
                    <!-- Page 1: Name and Description -->
                    <div id="page-1" class="modal-page">
                        <div class="form-group">
                            <label for="club-name-input">Name (Permanent, forms URL: /club/YourClubName)</label>
                            <input type="text" id="club-name-input" name="name" placeholder="Club Name" required>
                            <span id="club-name-error" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="club-title-input">Title (Optional, see name)</label>
                            <input type="text" id="club-title-input" name="title" placeholder="Club Title">
                        </div>
                        <div class="form-group">
                            <label for="club-description-text">Description (Optional, up to 500 char)</label>
                            <textarea id="club-description-text" name="description" placeholder="Description" maxlength="500"></textarea>
                            <span id="club-desc-error" class="error"></span>
                        </div>
                        <div class="form-group">
                            <label for="submission-textarea">Rules (Optional, post rules)</label>
                            <textarea id="submission-textarea" name="submission" placeholder="Submission Guidelines"></textarea>
                        </div>
                    </div>
                    <!-- Page 2: Banner and Image -->
                    <div id="page-2" class="modal-page" style="display: none;">
                        <div class="form-group">
                            <label for="banner-input-file">Banner (Optional, 4000x128px recommended)</label>
                            <input type="file" id="banner-input-file" name="banner" accept="image/*">
                            <img src="/assets/default-banner.jpg" alt="Banner Preview" class="banner-preview-img preview-image">
                        </div>
                        <div class="form-group">
                            <label for="club-image-input">Image (Optional, 256x256px recommended)</label>
                            <input type="file" id="club-image-input" name="image" accept="image/*">
                            <img src="/assets/default-image.jpg" alt="Image Preview" class="preview-image-img preview-image">
                        </div>
                    </div>
                    <!-- Page 3: Topics -->
                    <div id="page-3" class="modal-page" style="display: none;">
                        <div class="form-group">
                            <label for="topic-search-input">Topics (Select up to 3)</label>
                            <input type="text" id="topic-search-input" placeholder="Search topics...">
                            <div id="selected-topics-list"></div>
                            <span id="topics-error-list" class="error"></span>
                            <div id="topics-list-div"></div>
                        </div>
                    </div>
                    <!-- Page 4: Club Type and Settings -->
                    <div id="page-4" class="modal-page" style="display: none;">
                        <div class="form-group">
                            <label for="type-select">Type</label>
                            <select id="type-select" name="type">
                                <option value="public">Public - anyone can view, post, comment</option>
                                <option value="restricted">Restricted - anyone can view, approved users post</option>
                                <option value="private">Private - only approved users can view and contribute</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="club-mature-checkbox">Mature (18+)</label>
                            <input type="checkbox" id="club-mature-checkbox" name="mature">
                        </div>
                        <div class="form-group">
                            <label for="wiki-checkbox">Enable Wiki</label>
                            <input type="checkbox" id="wiki-checkbox" name="wiki">
                        </div>
                        <div class="form-group">
                            <label for="spam-filter-select">Spam Filter</label>
                            <select id="spam-filter-select" name="spam-filter">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Content Options</label>
                            <div>
                                <input type="checkbox" id="content-text-check" name="content-text" checked> Text
                                <input type="checkbox" id="content-images-check" name="content-images"> Images
                                <input type="checkbox" id="content-links-check" name="content-links"> Links
                                <input type="checkbox" id="content-polls-check" name="content-polls"> Polls
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="club-discoverable-checkbox">Discoverable in Search/Recommendations</label>
                            <input type="checkbox" id="club-discoverable-checkbox" name="discoverable" checked>
                        </div>
                        <div class="form-group">
                            <label>Other Options</label>
                            <div>
                                <input type="checkbox" id="post-flair-check" name="post-flair" checked> Flair
                                <input type="checkbox" id="nsfw-tags-check" name="nsfw-tags"> NSFW
                                <input type="checkbox" id="spoiler-tags-check" name="spoiler-tags"> Spoiler
                            </div>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('create-club-modal', false)">Cancel</button>
                        <div>
                            <button type="button" class="neumorphic-btn" id="prev-page-btn-club" onclick="navigateModal(-1)" style="display: none;">Back</button>
                            <button type="button" class="neumorphic-btn primary" id="next-page-btn" onclick="navigateModal(1)">Next</button>
                            <button type="submit" class="neumorphic-btn primary" id="create-club-btn" style="display: none;">Create Club</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Join Club Modal -->
    <div id="modal-join-club-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="join-club-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="join-club-title">Join a Club</h3>
                <button class="neumorphic-btn" aria-label="Close modal" onclick="modalToggle('modal-join-club-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="join-club-form">
                    <div class="form-group">
                        <label for="code-input-text">Invite Code ID</label>
                        <input type="text" id="code-input-text" name="invite-code" placeholder="Enter invite code" required>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('modal-join-club-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Join Club</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Post Creation Modal -->
    <div id="post-form-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="post-title-form">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="post-title-form">Create a Post</h3>
                <button class="neumorphic-btn" aria-label="Close modal" onclick="modalToggle('post-form-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="post-form-create">
                    <div class="form-group">
                        <label for="post-title">Post Title</label>
                        <input type="text" id="post-title" name="post-title" placeholder="Post Title" required>
                    </div>
                    <div class="form-group">
                        <label for="post-content-textarea">Content</label>
                        <textarea id="post-content-textarea" name="post-content" placeholder="Content Post"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="post-media">Media</label>
                        <input type="file" id="post-media" name="post-media" accept="image/*,video/*">
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('post-form-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Create Post</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="edit-message-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-message-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="edit-message-title">Edit Message</h3>
                <button class="neumorphic-btn" aria-label="Close modal" onclick="modalToggle('edit-message-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="edit-message-form">
                    <div class="form-group">
                        <label for="edit-message-text">Message</label>
                        <textarea id="edit-message-text" name="message-text" placeholder="Edit your message" required></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('edit-message-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>

<script>
// Utility function for API requests
async function apiRequest(endpoint, options = {}) {
    const token = localStorage.getItem('wristband');
    const headers = {
        'Content-Type': 'application/json',
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
        ...options.headers,
    };

    console.log(`[DEBUG] API Request: ${endpoint}, Token: ${token ? token.slice(0, 10) + '...' : 'none'}`);

    try {
        const response = await fetch(`http://localhost:8080${endpoint}`, {
            ...options,
            headers,
        });

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error(`[ERROR] Non-JSON response from ${endpoint}: ${response.status}`);
            throw new Error('Server returned non-JSON response');
        }

        const data = await response.json();

        if (!response.ok) {
            console.error(`[ERROR] API ${endpoint} failed: ${data.message || response.statusText}`);
            throw new Error(data.message || response.statusText);
        }

        return data;
    } catch (error) {
        console.error(`[ERROR] API Request failed: ${endpoint} - ${error.message}`);
        throw error;
    }
}

// Navigation function to handle unauthenticated users
function navigateTo(url) {
    const token = localStorage.getItem('token');
    if (!token && url !== '/index.html') {
        showNotification('Please log in to access this page.', 'error');
        window.location.href = '/index.html';
    } else {
        window.location.href = url;
    }
}

// Mock user ID and username
const currentUserId = localStorage.getItem('currentUserId') || 'user123';
const currentUsername = currentUserId ? (currentUserId.charAt(0).toUpperCase() + currentUserId.slice(1)) : 'User';

// Global state
let socketIO;
let isSocketInitialized = false;
if (!window.clubData) {
    window.clubData = JSON.parse(localStorage.getItem(`clubs_${currentUserId}`)) || [];
}
let messageData = {};
let currentPage = 0;
let selectedTopics = [];

const topics = {
    "Anime & Cosplay": ["Anime", "Manga", "Cosplay", "Anime Conventions", "Fan Art"],
    "Art": ["Drawing", "Painting", "Sculpture", "Photography", "Digital Art"],
    "Books": ["Fiction", "Non-Fiction", "Sci-Fi", "Fantasy", "Mystery"],
    "Gaming": ["Video Games", "Board Games", "Card Games", "Role-Playing Games", "Esports"],
    "Movies & TV": ["Movies", "TV Shows", "Documentaries", "Streaming Platforms", "Film Reviews"],
    "Music": ["Pop", "Rock", "Classical", "Jazz", "Electronic"],
    "Sports": ["Football", "Basketball", "Soccer", "Tennis", "Olympics"],
    "Technology": ["Gadgets", "Software", "AI", "Cybersecurity", "Programming"],
    "Travel": ["Adventure Travel", "City Breaks", "Cultural Experiences", "Budget Travel", "Luxury Travel"],
    "Food & Drink": ["Cooking", "Baking", "Wine", "Craft Beer", "Vegan Recipes"]
};

// Initialize Socket.IO
function initializeSocketIO() {
    const token = localStorage.getItem('token');
    if (!token) {
        console.error('No authentication token found.');
        showNotification('Please log in to access chat features.', 'error');
        navigateTo('/index.html');
        return false;
    }

    try {
        socketIO = io('http://localhost:8080', {
            auth: { token, userId: currentUserId },
            reconnectionAttempts: 3,
            reconnectionDelay: 1000
        });

        socketIO.on('connect', () => {
            console.log('Socket.IO connected');
            const currentClub = localStorage.getItem('currentClubId');
            if (currentClub) {
                socketIO.emit('joinClub', { clubId: currentClub, userId: currentUserId });
            }
        });

        socketIO.on('connect_error', (err) => {
            console.error('Socket.IO connection error:', err.message);
            if (err.message.includes('401')) {
                showNotification('Authentication failed.', 'error');
                navigateTo('/index.html');
            } else {
                showNotification('Failed to connect to server.', 'error');
            }
        });

        socketIO.on('message', ({ clubId, message }) => {
            if (clubId === localStorage.getItem('currentClubId')) {
                saveMessage(clubId, message);
                renderChatMessages(clubId);
                window.dispatchEvent(new Event('messagesRendered'));
            }
        });

        socketIO.on('editMessage', ({ clubId, messageIndex, newText }) => {
            if (messageData[clubId]?.[messageIndex]) {
                messageData[clubId][messageIndex].text = newText;
                messageData[clubId][messageIndex].isEdited = true;
                localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
                if (clubId === localStorage.getItem('currentClubId')) {
                    renderChatMessages(clubId);
                    window.dispatchEvent(new Event('messagesRendered'));
                }
            }
        });

        socketIO.on('deleteMessage', ({ clubId, messageIndex }) => {
            if (messageData[clubId]?.[messageIndex]) {
                messageData[clubId].splice(messageIndex, 1);
                localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
                if (clubId === localStorage.getItem('currentClubId')) {
                    renderChatMessages(clubId);
                    window.dispatchEvent(new Event('messagesRendered'));
                }
            }
        });

        socketIO.on('clubCreated', (newClub) => {
            clubData.push(newClub);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            renderClub();
        });

        socketIO.on('clubDeleted', (clubId) => {
            clubData = clubData.filter(club => club.id !== clubId);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            localStorage.removeItem(`chat_${clubId}`);
            if (clubId === localStorage.getItem('currentClubId')) {
                localStorage.removeItem('currentClubId');
            }
            renderClub();
        });

        isSocketInitialized = true;
        return true;
    } catch (error) {
        console.error('Socket.IO initialization failed:', error);
        showNotification('Failed to initialize chat system.', 'error');
        return false;
    }
}

// Load club details
async function loadClub(clubId, clubContainerId) {
    const clubContainer = document.getElementById(clubContainerId || 'club-info-section');
    if (!clubContainer) {
        return;
    }

    if (!clubId) {
        clubContainer.className = 'club-info-section error';
        clubContainer.innerHTML = '<p>No club ID provided. <a href="/main.html">Return to main page</a>.</p>';
        return;
    }

    clubContainer.className = 'club-info-section loading';
    clubContainer.innerHTML = 'Loading club data...';

    try {
        const clubData = await apiRequest(`/api/clubs/${clubId}`);
        clubContainer.className = 'club-info-section';

        const isMember = clubData.members.some(member => member.id === currentUserId);
        const isPending = clubData.type === 'restricted' && !isMember;

        clubContainer.innerHTML = `
            <img src="${clubData.image || '/assets/default-image.jpg'}" alt="${DOMPurify.sanitize(clubData.name)}" width="200" />
            <h2>${DOMPurify.sanitize(clubData.name)}</h2>
            <p>${DOMPurify.sanitize(clubData.description || 'No description provided.')}</p>
            <p>Type: ${clubData.type.charAt(0).toUpperCase() + clubData.type.slice(1)}</p>
            <p>Members: ${clubData.members.length}</p>
            <p>Created by: ${DOMPurify.sanitize(clubData.creator.username)}</p>
            <p class="membership-status">
                Status: ${isMember ? 'Member' : isPending ? 'Pending Approval' : 'Not a Member'}
            </p>
        `;

        // Update top section
        const titleElement = document.getElementById('club-title');
        const photoElement = document.getElementById('club-photo');
        const bannerImg = document.getElementById('club-top-img');
        const joinBtn = document.getElementById('join-club-btn');
        const deleteBtn = document.getElementById('delete-club-option');

        if (titleElement) titleElement.textContent = DOMPurify.sanitize(clubData.name);
        if (photoElement) photoElement.src = clubData.image || '/assets/default-club-image.jpg';
        if (bannerImg) bannerImg.src = clubData.banner || '/assets/default-banner.jpg';
        if (joinBtn) joinBtn.style.display = isMember ? 'none' : 'inline-block';
        if (deleteBtn) deleteBtn.style.display = clubData.creator.id === currentUserId ? 'block' : 'none';

        console.log('[CLUB] Loaded details successfully');
    } catch (error) {
        console.error(`[CLUB] Failed to load club details: ${error.message}`);
        clubContainer.className = 'club-info-section error';
        clubContainer.innerHTML = `<p>Error loading club: ${DOMPurify.sanitize(error.message)} <a href="/main.html">Return to main page</a></p>`;
    }
}

// Toggle modal
function modalToggle(modalId, showModal) {
    const modal = document.getElementById(modalId);
    let overlay = document.querySelector('.modal-overlay');
    if (!modal) return;

    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        document.body.appendChild(overlay);
    }

    modal.classList.toggle('active', showModal);
    overlay.classList.toggle('active', showModal);

    if (showModal) {
        modal.focus();
    } else if (modalId === 'create-club-modal') {
        resetClubModal();
    }
}

// Reset create club modal
function resetClubModal() {
    const form = document.getElementById('create-club-form');
    const bannerImg = document.querySelector('.banner-preview-img');
    const imageImg = document.querySelector('.preview-image-img');
    const matureCheckbox = document.getElementById('club-mature-checkbox');

    if (form) form.reset();
    if (bannerImg) bannerImg.src = '/assets/default-banner.jpg';
    if (imageImg) imageImg.src = '/assets/default-image.jpg';
    if (matureCheckbox) matureCheckbox.checked = false;

    selectedTopics = [];
    currentPage = 0;
    updateModalPage();
    renderTopicList('');
}

// Show notification
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    if (notification) {
        notification.textContent = DOMPurify.sanitize(message);
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }
}

// Validate page
function validatePage(page) {
    let isValid = true;
    if (page === 1) {
        const nameInput = document.getElementById('club-name-input');
        const descInput = document.getElementById('club-description-text');
        const nameError = document.getElementById('club-name-error');
        const descError = document.getElementById('club-desc-error');

        if (!nameInput || !descInput) {
            showNotification('Form inputs missing', 'error');
            return false;
        }

        const name = nameInput.value.trim();
        const description = descInput.value.trim();

        if (!name) {
            nameError.textContent = 'Club Name is required';
            nameError.style.display = 'block';
            showNotification('Club name required', 'error');
            isValid = false;
        } else if (clubData.some(club => club.name.toLowerCase() === name.toLowerCase())) {
            nameError.textContent = 'Club name must be unique';
            nameError.style.display = 'block';
            showNotification('Club name must be unique', 'error');
            isValid = false;
        } else if (!/^[a-zA-Z0-9_]+$/.test(name)) {
            nameError.textContent = 'Name can only contain letters, numbers, and underscores';
            nameError.style.display = 'block';
            showNotification('Invalid name format', 'error');
            isValid = false;
        } else {
            nameError.style.display = 'none';
        }

        if (description && description.length > 500) {
            descError.textContent = 'Description cannot exceed 500 characters';
            descError.style.display = 'block';
            showNotification('Description too long', 'error');
            isValid = false;
        } else {
            descError.style.display = 'none';
        }
    } else if (page === 3) {
        const topicsError = document.getElementById('topics-error-list');
        if (selectedTopics.length === 0) {
            topicsError.textContent = 'At least one topic is required';
            topicsError.style.display = 'block';
            showNotification('At least one topic required', 'error');
            isValid = false;
        } else {
            topicsError.style.display = 'none';
        }
    }
    return isValid;
}

// Navigate modal
function navigateModal(direction) {
    if (direction > 0 && !validatePage(currentPage + 1)) {
        return;
    }
    currentPage = Math.max(0, Math.min(3, currentPage + direction));
    updateModalPage();
}

// Render club lists
async function renderClub() {
    const joinedClubsList = document.getElementById('joined-clubs-list');
    const myClubsList = document.getElementById('my-clubs-list');
    const availableClubsList = document.getElementById('available-clubs-list');
    const clubListEmpty = document.getElementById('club-list-empty');
    const noClubs = document.getElementById('no-clubs');
    const topSection = document.getElementById('top-section');
    const mainContent = document.getElementById('main-content');

    if (joinedClubsList) joinedClubsList.innerHTML = '';
    if (myClubsList) myClubsList.innerHTML = '';
    if (availableClubsList) availableClubsList.innerHTML = '';

    try {
        const clubsData = await apiRequest('/api/clubs');
        clubData = clubsData;
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
    } catch (error) {
        console.error('Club fetch failed:', error);
        showNotification('Failed to load clubs.', 'error');
    }

    if (clubData.length === 0) {
        if (clubListEmpty) clubListEmpty.style.display = 'block';
        if (noClubs) noClubs.style.display = 'flex';
        if (topSection) topSection.style.display = 'none';
        if (mainContent) mainContent.style.display = 'none';
        localStorage.removeItem('currentClubId');
        return;
    }

    if (clubListEmpty) clubListEmpty.style.display = 'none';
    if (noClubs) noClubs.style.display = 'none';
    if (topSection) topSection.style.display = 'block';
    if (mainContent) mainContent.style.display = 'flex';

    const currentClubId = localStorage.getItem('currentClubId');
    const myClubs = clubData.filter(club => club.creator.id === currentUserId);
    const joinedClubs = clubData.filter(club => 
        club.members.some(m => m.id === currentUserId) && club.creator.id !== currentUserId
    );
    const availableClubs = clubData.filter(club => 
        !club.members.some(m => m.id === currentUserId) && club.type === 'public'
    );

    const sortClubs = (clubs) => {
        const selectedClub = clubs.find(club => club.id === currentClubId);
        const otherClubs = clubs.filter(club => club.id !== currentClubId);
        return selectedClub ? [selectedClub, ...otherClubs] : otherClubs;
    };

    const renderClubItem = (club) => {
        const isSelected = club.id === currentClubId;
        return `
            <div class="club-item ${isSelected ? 'selected' : ''}" data-club-id="${club.id}" onclick="selectClub('${club.id}')" role="button" aria-label="Select club ${club.name}">
                <img src="${club.image || '/assets/default-image.jpg'}" alt="${DOMPurify.sanitize(club.name)}">
                <div>
                    <h4>${DOMPurify.sanitize(club.name)}</h4>
                    <p>${DOMPurify.sanitize(club.description?.slice(0, 50) || '')}${club.description?.length > 50 ? '...' : ''}</p>
                </div>
            </div>
        `;
    };

    if (myClubsList) myClubsList.innerHTML = sortClubs(myClubs).map(renderClubItem).join('');
    if (joinedClubsList) joinedClubsList.innerHTML = sortClubs(joinedClubs).map(renderClubItem).join('');
    if (availableClubsList) availableClubsList.innerHTML = sortClubs(availableClubs).map(renderClubItem).join('');

    if (currentClubId) {
        const currentClub = clubData.find(club => club.id === currentClubId);
        if (!currentClub) {
            localStorage.removeItem('currentClubId');
            renderClub();
            return;
        }
        loadClub(currentClubId);
        renderChatMessages(currentClubId);
    }
}

// Select club
function selectClub(clubId) {
    localStorage.setItem('currentClubId', clubId);
    if (isSocketInitialized) {
        socketIO.emit('joinClub', { clubId, userId: currentUserId });
    }
    loadClub(clubId);
    renderClub();
    renderChatMessages(clubId);
    window.dispatchEvent(new Event('clubSelected'));
    const clubList = document.getElementById('club-list');
    if (clubList) {
        clubList.classList.remove('show');
        document.getElementById('club-list-toggle').classList.remove('active');
    }
}

// Render topics
function renderTopicList(filter = '') {
    const topicListDiv = document.getElementById('topics-list-div');
    const selectedTopicsDiv = document.getElementById('selected-topics-list');
    if (!topicListDiv || !selectedTopicsDiv) return;

    topicListDiv.innerHTML = '';

    try {
        Object.entries(topics).forEach(([category, topicItems]) => {
            const filteredTopics = topicItems.filter(topic => 
                topic.toLowerCase().includes(filter.toLowerCase())
            );
            if (filteredTopics.length > 0) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'topic-category';
                categoryDiv.innerHTML = `<h4>${DOMPurify.sanitize(category)}</h4>`;
                filteredTopics.forEach(topic => {
                    const topicDiv = document.createElement('div');
                    topicDiv.className = `topic-item ${selectedTopics.includes(topic) ? 'selected' : ''}`;
                    topicDiv.textContent = DOMPurify.sanitize(topic);
                    topicDiv.onclick = () => toggleTopic(topic);
                    topicDiv.setAttribute('role', 'button');
                    topicDiv.setAttribute('aria-label', `Toggle topic ${topic}`);
                    categoryDiv.appendChild(topicDiv);
                });
                topicListDiv.appendChild(categoryDiv);
            }
        });

        selectedTopicsDiv.innerHTML = selectedTopics.map(topic => 
            `<span class="topic-item selected">${DOMPurify.sanitize(topic)}</span>`
        ).join('');
    } catch (error) {
        console.error('Topic render error:', error);
        showNotification('Failed to render topics.', 'error');
    }
}

// Toggle topic
function toggleTopic(topic) {
    if (selectedTopics.includes(topic)) {
        selectedTopics = selectedTopics.filter(t => t !== topic);
    } else if (selectedTopics.length < 3) {
        selectedTopics.push(topic);
    } else {
        showNotification('Maximum 3 topics allowed.', 'error');
        return;
    }
    const topicSearch = document.getElementById('topic-search-input');
    renderTopicList(topicSearch ? topicSearch.value : '');
}

// Save message to LocalStorage
function saveMessage(clubId, message) {
    if (!messageData[clubId]) {
        messageData[clubId] = JSON.parse(localStorage.getItem(`chat_${clubId}`)) || [];
    }
    messageData[clubId].push(message);
    localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
}

// Additional dropdown functions
function openModdingTools() {
    showNotification('Modding tools not implemented yet.', 'error');
    // Placeholder for future implementation
}

function copyInviteLink() {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(club => club.id === currentClubId);
    if (club) {
        const inviteLink = `${window.location.origin}/clubs.html?clubId=${club.id}`;
        navigator.clipboard.writeText(inviteLink)
            .then(() => showNotification('Invite link copied!', 'success'))
            .catch(() => showNotification('Failed to copy invite link.', 'error'));
    }
}

function openClubSettings() {
    showNotification('Club settings not implemented yet.', 'error');
    // Placeholder for future implementation
}

function toggleTheme() {
    document.body.classList.toggle('dark-theme');
    localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    showNotification('Theme toggled.', 'success');
}

function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('currentUserId');
    localStorage.removeItem('currentClubId');
    if (isSocketInitialized) {
        socketIO.disconnect();
    }
    navigateTo('/index.html');
    showNotification('Logged out successfully.', 'success');
}

// Event listeners
document.getElementById('create-club-nav-btn').addEventListener('click', () => {
    modalToggle('create-club-modal', true);
});

document.getElementById('create-club-no-club-btn').addEventListener('click', () => {
    modalToggle('create-club-modal', true);
});

document.getElementById('topic-search-input').addEventListener('input', (e) => {
    renderTopicList(e.target.value);
});

document.getElementById('create-club-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!validatePage(currentPage + 1)) return;

    const bannerFile = document.getElementById('banner-input-file').files?.[0];
    const imageFile = document.getElementById('club-image-input').files?.[0];

    const readFileAsBase64 = (file) => new Promise((resolve) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
    });

    const [bannerBase64, imageBase64] = await Promise.all([
        readFileAsBase64(bannerFile) || '/assets/default-banner.jpg',
        readFileAsBase64(imageFile) || '/assets/default-image.jpg'
    ]);

    const newClub = {
        id: `club-${Date.now()}`,
        name: document.getElementById('club-name-input').value.trim(),
        title: document.getElementById('club-title-input').value.trim(),
        description: document.getElementById('club-description-text').value.trim(),
        submissionText: document.getElementById('submission-textarea').value.trim(),
        type: document.getElementById('type-select').value,
        topics: selectedTopics,
        mature: document.getElementById('club-mature-checkbox').checked,
        wiki: document.getElementById('wiki-checkbox').checked,
        spamFilter: document.getElementById('spam-filter-select').value || 'medium',
        contentOptions: {
            text: document.getElementById('content-text-check').checked,
            images: document.getElementById('content-images-check').checked,
            links: document.getElementById('content-links-check').checked,
            polls: document.getElementById('content-polls-check').checked
        },
        discoverable: document.getElementById('club-discoverable-checkbox').checked,
        otherOptions: {
            postFlair: document.getElementById('post-flair-check').checked,
            nsfw: document.getElementById('nsfw-tags-check').checked,
            spoiler: document.getElementById('spoiler-tags-check').checked
        },
        banner: bannerBase64,
        image: imageBase64,
        creator: { id: currentUserId, username: currentUsername },
        members: [{ id: currentUserId, username: currentUsername }],
        online: 0,
        moderators: [],
        createdAt: new Date().toISOString().slice(0, 10)
    };

    try {
        const createdClub = await apiRequest('/api/clubs', {
            method: 'POST',
            body: JSON.stringify(newClub)
        });
        clubData.push(createdClub);
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('clubCreated', createdClub);
        }
        modalToggle('create-club-modal', false);
        selectClub(createdClub.id);
        showNotification('Club created successfully!', 'success');
    } catch (error) {
        console.error('Club creation failed:', error);
        showNotification('Failed to create club.', 'error');
    }
});

document.getElementById('banner-input-file').addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    const preview = document.querySelector('.banner-preview-img');
    if (file && preview) {
        const reader = new FileReader();
        reader.onload = () => { preview.src = reader.result; };
        reader.readAsDataURL(file);
    }
});

document.getElementById('club-image-input').addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    const preview = document.querySelector('.preview-image-img');
    if (file && preview) {
        const reader = new FileReader();
        reader.onload = () => { preview.src = reader.result; };
        reader.readAsDataURL(file);
    }
});

document.getElementById('more-options-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    const dropdown = document.querySelector('.dropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
});

document.addEventListener('click', (e) => {
    const dropdowns = document.querySelectorAll('.dropdown.active');
    dropdowns.forEach(d => {
        if (!d.contains(e.target)) {
            d.classList.remove('active');
        }
    });
});

document.getElementById('club-list-toggle').addEventListener('click', () => {
    const clubList = document.getElementById('club-list');
    const toggleBtn = document.getElementById('club-list-toggle');
    if (clubList && toggleBtn) {
        clubList.classList.toggle('show');
        toggleBtn.classList.toggle('active');
    }
});

document.getElementById('create-post-btn').addEventListener('click', () => {
    modalToggle('post-form-modal', true);
});

document.getElementById('post-form-create').addEventListener('submit', async (e) => {
    e.preventDefault();
    const titleInput = document.getElementById('post-title');
    const contentInput = document.getElementById('post-content-textarea');
    const mediaInput = document.getElementById('post-media');
    const currentClubId = localStorage.getItem('currentClubId');

    if (!titleInput || !currentClubId) {
        showNotification('Post title or club ID missing.', 'error');
        return;
    }

    const title = titleInput.value.trim();
    const content = contentInput?.value.trim();
    const mediaFile = mediaInput?.files?.[0];

    if (!title) {
        showNotification('Post title is required', 'error');
        return;
    }

    const message = {
        id: `post-${Date.now()}`,
        senderId: currentUserId,
        sender: currentUsername,
        text: `<strong>${DOMPurify.sanitize(title)}</strong><br>${DOMPurify.sanitize(content || '')}`,
        timestamp: new Date().toISOString()
    };

    if (mediaFile) {
        const reader = new FileReader();
        reader.onload = () => {
            if (mediaFile.type.startsWith('image/')) {
                message.image = reader.result;
            } else if (mediaFile.type.startsWith('video/')) {
                message.video = reader.result;
            }
            if (isSocketInitialized) {
                socketIO.emit('message', { clubId: currentClubId, message });
            }
            saveMessage(currentClubId, message);
            renderChatMessages(currentClubId);
            window.dispatchEvent(new Event('messagesRendered'));
        };
        reader.readAsDataURL(mediaFile);
    } else {
        if (isSocketInitialized) {
            socketIO.emit('message', { clubId: currentClubId, message });
        }
        saveMessage(currentClubId, message);
        renderChatMessages(currentClubId);
        window.dispatchEvent(new Event('messagesRendered'));
    }

    modalToggle('post-form-modal', false);
    titleInput.value = '';
    if (contentInput) contentInput.value = '';
    if (mediaInput) mediaInput.value = '';
    showNotification('Post created successfully!', 'success');
});

document.getElementById('join-club-btn').addEventListener('click', () => {
    modalToggle('modal-join-club-modal', true);
});

document.getElementById('join-club-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const inviteCodeInput = document.getElementById('code-input-text');
    const currentClubId = localStorage.getItem('currentClubId');

    if (!inviteCodeInput || !currentClubId) {
        showNotification('Invite code or club ID missing.', 'error');
        return;
    }

    const inviteCode = inviteCodeInput.value.trim();
    const club = clubData.find(c => c.id === currentClubId);

    if (club && inviteCode === club.id) { // Mock invite code validation
        try {
            await apiRequest(`/api/clubs/${currentClubId}/join`, {
                method: 'POST',
                body: JSON.stringify({ inviteCode })
            });
            if (!club.members.some(m => m.id === currentUserId)) {
                club.members.push({ id: currentUserId, username: currentUsername });
                localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
                if (isSocketInitialized) {
                    socketIO.emit('joinClub', { clubId: currentClubId, userId: currentUserId });
                }
                renderClub();
                modalToggle('modal-join-club-modal', false);
                showNotification('Joined club successfully!', 'success');
            } else {
                showNotification('You are already a member of this club', 'error');
            }
        } catch (error) {
            console.error('Join club failed:', error);
            showNotification('Failed to join club.', 'error');
        }
    } else {
        showNotification('Invalid invite code.', 'error');
    }
});

document.getElementById('send-message-btn').addEventListener('click', () => {
    const chatInput = document.getElementById('chat-input-text');
    const mediaInput = document.getElementById('chat-media-input');
    const currentClubId = localStorage.getItem('currentClubId');

    if (!chatInput || !currentClubId) {
        showNotification('Cannot send message. Missing input or club ID.', 'error');
        return;
    }

    const text = chatInput.value.trim();
    const mediaFile = mediaInput?.files?.[0];

    if (!text && !mediaFile) {
        showNotification('Message or media is required.', 'error');
        return;
    }

    const message = {
        id: `msg-${Date.now()}`,
        senderId: currentUserId,
        sender: currentUsername,
        text: DOMPurify.sanitize(text || ''),
        timestamp: new Date().toISOString()
    };

    if (mediaFile) {
        const reader = new FileReader();
        reader.onload = () => {
            if (mediaFile.type.includes('image/')) {
                message.image = reader.result;
            } else if (mediaFile.type.includes('video/')) {
                message.video = reader.result;
            }
            if (isSocketInitialized) {
                socketIO.emit('message', { clubId: currentClubId, message });
            }
            saveMessage(currentClubId, message);
            renderChatMessages(currentClubId);
            window.dispatchEvent(new Event('messagesRendered'));
            chatInput.value = '';
            mediaInput.value = '';
        };
        reader.readAsDataURL(mediaFile);
    } else {
        if (isSocketInitialized) {
            socketIO.emit('message', { clubId: currentClubId, message });
        }
        saveMessage(currentClubId, message);
        renderChatMessages(currentClubId);
        window.dispatchEvent(new Event('messagesRendered'));
        chatInput.value = '';
    }
});

document.getElementById('upload-media-btn').addEventListener('click', () => {
    const mediaInput = document.getElementById('chat-media-input');
    if (mediaInput) {
        mediaInput.click();
    }
});

document.getElementById('edit-message-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const editInput = document.getElementById('edit-message-text');
    const currentClubId = localStorage.getItem('currentClubId');
    const messageIndex = editInput.dataset.messageIndex;

    if (!editInput || !currentClubId || !messageIndex) {
        showNotification('Cannot edit message. Missing input or club ID.', 'error');
        return;
    }

    const newText = editInput.value.trim();
    if (newText && messageData[currentClubId]?.[messageIndex]) {
        messageData[currentClubId][messageIndex].text = DOMPurify.sanitize(newText);
        messageData[currentClubId][messageIndex].isEdited = true;
        localStorage.setItem(`chat_${currentClubId}`, JSON.stringify(messageData[currentClubId]));
        if (isSocketInitialized) {
            socketIO.emit('messageEdit', { clubId: currentClubId, messageIndex: Number(messageIndex), newText });
        }
        renderChatMessages(currentClubId);
        window.dispatchEvent(new Event('messagesRendered'));
        modalToggle('edit-message-modal', false);
        showNotification('Message edited', 'success');
    }
});

document.addEventListener('click', (e) => {
    const overlay = document.querySelector('.modal-overlay.active');
    if (overlay && e.target === overlay) {
        const modals = document.querySelectorAll('.modal.active');
        modals.forEach(modal => modalToggle(modal.id, false));
    }
});

document.addEventListener('click', (e) => {
    const menuContents = document.querySelectorAll('.message-menu-content.active');
    menuContents.forEach(content => {
        if (!content.contains(e.target) && !e.target.closest('.message-menu')) {
            content.classList.remove('active');
        }
    });
});

function addToFavorites() {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(club => club.id === currentClubId);
    if (club) {
        club.favorite = !club.favorite;
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        showNotification(club.favorite ? 'Added to favorites' : 'Removed from favorites', 'success');
        renderClub();
    }
}

function muteClub() {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(club => club.id === currentClubId);
    if (club) {
        club.muted = !club.muted;
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        showNotification(club.muted ? 'Club muted' : 'Club unmuted', 'success');
    }
}

function deleteClub() {
    const currentClubId = localStorage.getItem('currentClubId');
    if (confirm('Are you sure you want to delete this club?')) {
        try {
            apiRequest(`/api/clubs/${currentClubId}`, { method: 'DELETE' });
            clubData = clubData.filter(club => club.id !== currentClubId);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            localStorage.removeItem(`chat_${currentClubId}`);
            if (isSocketInitialized) {
                socketIO.emit('clubDeleted', currentClubId);
            }
            localStorage.removeItem('currentClubId');
            renderClub();
            showNotification('Club deleted', 'success');
        } catch (error) {
            console.error('Club deletion failed:', error);
            showNotification('Club deletion failed.', 'error');
        }
    }
}

// Initialize page
async function init() {
    initializeSocketIO();
    const theme = localStorage.getItem('theme');
    if (theme === 'dark') {
        document.body.classList.add('dark-theme');
    }

    const urlParams = new URLSearchParams(window.location.search);
    const clubId = urlParams.get('clubId');
    if (clubId) {
        localStorage.setItem('currentClubId', clubId);
        await loadClub(clubId);
        if (isSocketInitialized) {
            socketIO.emit('joinClub', { clubId, userId: currentUserId });
        }
        renderClub();
    } else {
        renderClub();
    }
}

// Call initialization
init();

// Close modals on overlay click
document.addEventListener('click', (e) => {
    const overlay = document.querySelector('.modal-overlay.active');
    if (overlay && e.target === overlay) {
        const modals = document.querySelectorAll('.modal.active');
        modals.forEach(modal => modalToggle(modal.id, false));
    }
});

// Toggle message menu
document.addEventListener('click', (e) => {
    const menuContents = document.querySelectorAll('.message-menu-content.active');
    menuContents.forEach(content => {
        if (!content.contains(e.target) && !e.target.closest('.message-menu')) {
            content.classList.remove('active');
        }
    });
});

// Handle notifications button
document.getElementById('notifications-btn').addEventListener('click', () => {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    if (club) {
        club.notifications = !club.notifications;
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('notificationToggle', { clubId: currentClubId, enabled: club.notifications });
        }
        showNotification(club.notifications ? 'Notifications enabled' : 'Notifications disabled', 'success');
    }
});

// Handle modding tools button
document.getElementById('modding-tools-btn').addEventListener('click', () => {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    if (club && (club.moderators.some(m => m.id === currentUserId) || club.creator.id === currentUserId)) {
        modalToggle('modding-tools-modal', true);
        if (isSocketInitialized) {
            socketIO.emit('moddingToolsOpened', { clubId: currentClubId, userId: currentUserId });
        }
        showNotification('Accessing modding tools...', 'success');
    } else {
        showNotification('You do not have moderator permissions.', 'error');
    }
});

// Modding tools modal
function openModdingToolsModal() {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to access modding tools.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'modding-tools-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modding Tools</h3>
                <button class="neumorphic-btn" onclick="modalToggle('modding-tools-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Moderator Actions for ${sanitizeInput(club.name)}</p>
                <div class="form-group">
                    <button class="neumorphic-btn" onclick="banUser()">Ban User</button>
                    <button class="neumorphic-btn" onclick="muteUser()">Mute User</button>
                    <button class="neumorphic-btn" onclick="promoteModerator()">Promote Moderator</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('modding-tools-modal', false);
    });
}

// Placeholder modding actions
function banUser() {
    showNotification('Ban user functionality not implemented.', 'error');
}
function muteUser() {
    showNotification('Mute user functionality not implemented.', 'error');
}
function promoteModerator() {
    showNotification('Promote moderator functionality not implemented.', 'error');
}

// Handle media input change for chat
document.getElementById('chat-media-input').addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (file && validateFile(file)) {
        showNotification(`Selected ${sanitizeInput(file.name)} for upload.`, 'success');
    }
});

// Handle page navigation for create club modal
function updateModalPage() {
    const modal = document.getElementById('create-club-modal');
    if (!modal) return;

    const pages = modal.querySelectorAll('.modal-page');
    const progressSteps = modal.querySelectorAll('.modal-progress span');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    const createBtn = document.getElementById('create-club-btn');

    pages.forEach((page, index) => {
        page.style.display = index === currentPage ? 'block' : 'none';
    });

    progressSteps.forEach((step, index) => {
        step.classList.toggle('active', index === currentPage);
    });

    if (prevBtn) prevBtn.style.display = currentPage === 0 ? 'none' : 'inline-block';
    if (nextBtn) nextBtn.style.display = currentPage === 3 ? 'none' : 'inline-block';
    if (createBtn) createBtn.style.display = currentPage === 3 ? 'inline-block' : 'none';
}

// Handle topic search
document.getElementById('topic-search-input').addEventListener('input', (e) => {
    renderTopicList(e.target.value);
});

// Handle form submissions for edit message
document.getElementById('edit-message-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('edit-message-text');
    const form = e.target;
    const text = input.value.trim();
    const currentClubId = localStorage.getItem('currentClubId');
    const messageIndex = parseInt(form.dataset.messageIndex);
    if (text && currentClubId && !isNaN(messageIndex)) {
        editMessage(currentClubId, messageIndex, text);
        modalToggle('edit-message-modal', false);
    }
});

// Error boundary for async operations
async function safeExecute(fn, errorMessage = 'Operation failed.') {
    try {
        return await fn();
    } catch (error) {
        console.error(`${errorMessage}:`, error);
        showNotification(`${errorMessage}: ${error.message}`, 'error');
    }
}

// Handle window unload to clean up socket
window.addEventListener('unload', () => {
    if (isSocketInitialized) {
        socketIO.disconnect();
    }
});

// Responsive adjustments
window.addEventListener('resize', () => {
    const clubList = document.getElementById('club-list');
    if (clubList) {
        if (window.innerWidth <= 768 && clubList.classList.contains('show')) {
            clubList.classList.add('full-width');
        } else {
            clubList.classList.remove('full-width');
        }
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === '/') {
        const chatInput = document.getElementById('chat-input-text');
        if (chatInput) chatInput.focus();
    }
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal.active');
        modals.forEach(modal => modalToggle(modal.id, false));
        const clubList = document.getElementById('club-list');
        if (clubList?.classList.contains('show')) {
            clubList.classList.remove('show');
            document.getElementById('club-list-toggle')?.classList.remove('active');
        }
    }
});

// Handle dark theme toggle
function toggleTheme() {
    document.body.classList.toggle('dark-theme');
    localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    showNotification('Theme toggled.', 'success');
}

// Periodic club data refresh
setInterval(async () => {
    await safeExecute(() => renderClub(), 'Failed to refresh club data.');
}, 60000);

// Handle browser back/forward navigation
window.addEventListener('popstate', () => {
    const clubId = new URLSearchParams(window.location.search).get('clubId');
    if (clubId) {
        localStorage.setItem('currentClubId', clubId);
        loadClub(clubId);
        renderClub();
        if (isSocketInitialized) {
            socketIO.emit('joinClub', { clubId, userId: currentUserId });
        }
    } else {
        renderClub();
    }
});

// Prevent accidental form resubmission
if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
}

// Sanitize all user inputs
function sanitizeInput(input) {
    return DOMPurify.sanitize(input);
}

// Update chat input placeholder based on club
function updateChatPlaceholder() {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    const chatInput = document.getElementById('chat-input-text');
    if (club && chatInput) {
        chatInput.placeholder = `Message in ${sanitizeInput(club.name)}...`;
    }
}

// Call after club selection
document.addEventListener('clubSelected', updateChatPlaceholder);

// Handle file size validation for uploads
function validateFile(file, maxSizeMB = 5) {
    if (file && file.size > maxSizeMB * 1024 * 1024) {
        showNotification(`File size exceeds ${maxSizeMB}MB limit.`, 'error');
        return false;
    }
    return true;
}

// Validate media uploads
document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && !validateFile(file)) {
            e.target.value = '';
        }
    });
});

// Accessibility enhancements
function enhanceAccessibility() {
    document.querySelectorAll('button, input, textarea, select').forEach(el => {
        if (!el.getAttribute('aria-label') && !el.getAttribute('aria-labelledby')) {
            el.setAttribute('aria-label', el.placeholder || el.textContent || 'Interactive element');
        }
    });
}
enhanceAccessibility();

// Handle online/offline status
function updateOnlineStatus() {
    const currentClubId = localStorage.getItem('currentClubId');
    if (isSocketInitialized && currentClubId) {
        socketIO.emit('userStatus', {
            clubId: currentClubId,
            userId: currentUserId,
            online: navigator.onLine
        });
    }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Socket.IO user status handling
if (isSocketInitialized) {
    socketIO.on('userStatus', ({ clubId, userId, online }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club) {
            club.online = online ? (club.online || 0) + 1 : Math.max(0, (club.online || 0) - 1);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (clubId === localStorage.getItem('currentClubId')) {
                loadClub(clubId); // Update club info
            }
        }
    });
}

// Preload images for better performance
function preloadImages() {
    const images = ['/assets/default-image.jpg', '/assets/default-banner.jpg'];
    images.forEach(src => {
        const img = new Image();
        img.src = src;
    });
}
preloadImages();

// Handle context menu for messages
document.addEventListener('contextmenu', (e) => {
    const message = e.target.closest('.chat-message.own');
    if (message) {
        e.preventDefault();
        const menuContent = message.querySelector('.message-menu-content');
        if (menuContent) {
            document.querySelectorAll('.message-menu-content.active').forEach(content => {
                if (content !== menuContent) content.classList.remove('active');
            });
            menuContent.classList.toggle('active');
        }
    }
});

// Smooth scroll for chat messages
function scrollToBottom() {
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
        });
    }
}

// Call scrollToBottom after rendering messages
document.addEventListener('messagesRendered', scrollToBottom);

// Handle form validation on input
document.querySelectorAll('input, textarea').forEach(input => {
    input.addEventListener('input', () => {
        const errorEl = document.getElementById(`${input.id}-error`);
        if (errorEl) {
            errorEl.style.display = 'none';
        }
    });
});

// Handle club search
function searchClubs(query) {
    const filteredClubs = clubData.filter(club =>
        club.name.toLowerCase().includes(query.toLowerCase()) ||
        club.description?.toLowerCase().includes(query.toLowerCase())
    );
    renderClub(filteredClubs);
}

// Add search functionality
const navLeft = document.querySelector('.nav-left');
if (navLeft) {
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Search clubs...';
    searchInput.className = 'neumorphic-btn';
    searchInput.setAttribute('aria-label', 'Search clubs');
    searchInput.addEventListener('input', (e) => searchClubs(e.target.value));
    navLeft.prepend(searchInput);
}

// Handle club invitation link copy
function copyInviteLink() {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    if (club) {
        const inviteLink = `http://localhost:8080/clubs.html?clubId=${club.id}`;
        navigator.clipboard.writeText(inviteLink)
            .then(() => showNotification('Invite link copied!', 'success'))
            .catch(() => showNotification('Failed to copy link.', 'error'));
    }
}

// Add copy invite link to dropdown
const dropdownContent = document.querySelector('.dropdown-content');
if (dropdownContent) {
    const inviteOption = document.createElement('div');
    inviteOption.textContent = 'Copy Invite Link';
    inviteOption.onclick = copyInviteLink;
    inviteOption.setAttribute('role', 'button');
    inviteOption.setAttribute('aria-label', 'Copy invite link');
    dropdownContent.appendChild(inviteOption);
}

// Handle message reactions
function addReaction(clubId, messageIndex, reaction) {
    if (!messageData[clubId]?.[messageIndex]) return;
    messageData[clubId][messageIndex].reactions = messageData[clubId][messageIndex].reactions || {};
    messageData[clubId][messageIndex].reactions[reaction] = (messageData[clubId][messageIndex].reactions[reaction] || 0) + 1;
    localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
    if (isSocketInitialized) {
        socketIO.emit('reaction', { clubId, messageIndex, reaction });
    }
    renderChatMessages(clubId);
}

// Socket.IO reaction handling
if (isSocketInitialized) {
    socketIO.on('reaction', ({ clubId, messageIndex, reaction }) => {
        if (messageData[clubId]?.[messageIndex]) {
            messageData[clubId][messageIndex].reactions = messageData[clubId][messageIndex].reactions || {};
            messageData[clubId][messageIndex].reactions[reaction] = (messageData[clubId][messageIndex].reactions[reaction] || 0) + 1;
            localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
            if (clubId === localStorage.getItem('currentClubId')) {
                renderChatMessages(clubId);
            }
        }
    });
}

// Handle club deletion confirmation
function deleteClub() {
    const currentClubId = localStorage.getItem('currentClubId');
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'delete-club-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Deletion</h3>
                <button class="neumorphic-btn" onclick="modalToggle('delete-club-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this club? This action cannot be undone.</p>
                <div class="modal-buttons">
                    <button class="neumorphic-btn" onclick="modalToggle('delete-club-modal', false)">Cancel</button>
                    <button class="neumorphic-btn primary" onclick="confirmDeleteClub('${currentClubId}')">Delete</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('delete-club-modal', false);
    });
}

function confirmDeleteClub(clubId) {
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}`, { method: 'DELETE' });
        clubData = clubData.filter(club => club.id !== clubId);
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        localStorage.removeItem(`chat_${clubId}`);
        if (isSocketInitialized) {
            socketIO.emit('clubDeleted', clubId);
        }
        localStorage.removeItem('currentClubId');
        renderClub();
        showNotification('Club deleted successfully!', 'success');
        modalToggle('delete-club-modal', false);
    }, 'Failed to delete club');
}

// Handle message pinning
function pinMessage(clubId, messageIndex) {
    if (!messageData[clubId]?.[messageIndex]) return;
    messageData[clubId][messageIndex].pinned = !messageData[clubId][messageIndex].pinned;
    localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
    if (isSocketInitialized) {
        socketIO.emit('pinMessage', { clubId, messageIndex, pinned: messageData[clubId][messageIndex].pinned });
    }
    renderChatMessages(clubId);
    showNotification(messageData[clubId][messageIndex].pinned ? 'Message pinned' : 'Message unpinned', 'success');
}

// Socket.IO pin message handling
if (isSocketInitialized) {
    socketIO.on('pinMessage', ({ clubId, messageIndex, pinned }) => {
        if (messageData[clubId]?.[messageIndex]) {
            messageData[clubId][messageIndex].pinned = pinned;
            localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
            if (clubId === localStorage.getItem('currentClubId')) {
                renderChatMessages(clubId);
            }
        }
    });
}

// Handle club settings modal
function openClubSettings() {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    if (!club || (club.creator.id !== currentUserId && !club.moderators.some(m => m.id === currentUserId))) {
        showNotification('You do not have permission to edit club settings.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'club-settings-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Club Settings</h3>
                <button class="neumorphic-btn" onclick="modalToggle('club-settings-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="club-settings-form">
                    <div class="form-group">
                        <label for="settings-desc">Description</label>
                        <textarea id="settings-desc" name="description">${sanitizeInput(club.description || '')}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="settings-type">Type</label>
                        <select id="settings-type" name="type">
                            <option value="public" ${club.type === 'public' ? 'selected' : ''}>Public</option>
                            <option value="restricted" ${club.type === 'restricted' ? 'selected' : ''}>Restricted</option>
                            <option value="private" ${club.type === 'private' ? 'selected' : ''}>Private</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="settings-mature">Mature (18+)</label>
                        <input type="checkbox" id="settings-mature" name="mature" ${club.mature ? 'checked' : ''}>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('club-settings-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('club-settings-modal', false);
    });

    document.getElementById('club-settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const description = document.getElementById('settings-desc').value.trim();
        const type = document.getElementById('settings-type').value;
        const mature = document.getElementById('settings-mature').checked;

        await safeExecute(async () => {
            const updatedClub = await apiRequest(`/api/clubs/${currentClubId}`, {
                method: 'PATCH',
                body: JSON.stringify({ description, type, mature })
            });
            Object.assign(club, updatedClub);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            renderClub();
            loadClub(currentClubId);
            showNotification('Club settings updated!', 'success');
            modalToggle('club-settings-modal', false);
        }, 'Failed to update club settings');
    });
}

// Add club settings to dropdown
if (dropdownContent) {
    const settingsOption = document.createElement('div');
    settingsOption.textContent = 'Club Settings';
    settingsOption.onclick = openClubSettings;
    settingsOption.setAttribute('role', 'button');
    settingsOption.setAttribute('aria-label', 'Open club settings');
    dropdownContent.appendChild(settingsOption);
}

// Handle message search
function searchMessages(query) {
    const currentClubId = localStorage.getItem('currentClubId');
    if (!messageData[currentClubId]) return;

    const filteredMessages = messageData[currentClubId].filter(msg =>
        msg.text.toLowerCase().includes(query.toLowerCase()) ||
        msg.sender.toLowerCase().includes(query.toLowerCase())
    );
    renderChatMessages(currentClubId, filteredMessages);
}

// Add message search input
const chatSection = document.querySelector('.chat-section');
if (chatSection) {
    const messageSearchInput = document.createElement('input');
    messageSearchInput.type = 'text';
    messageSearchInput.placeholder = 'Search messages...';
    messageSearchInput.className = 'neumorphic-btn';
    messageSearchInput.setAttribute('aria-label', 'Search messages');
    messageSearchInput.addEventListener('input', (e) => searchMessages(e.target.value));
    chatSection.prepend(messageSearchInput);
}

// Handle message drafts
function saveDraft() {
    const chatInput = document.getElementById('chat-input-text');
    const currentClubId = localStorage.getItem('currentClubId');
    if (chatInput && currentClubId && chatInput.value.trim()) {
        localStorage.setItem(`draft_${currentClubId}`, chatInput.value);
    }
}

function loadDraft() {
    const chatInput = document.getElementById('chat-input-text');
    const currentClubId = localStorage.getItem('currentClubId');
    if (chatInput && currentClubId) {
        const draft = localStorage.getItem(`draft_${currentClubId}`);
        if (draft) {
            chatInput.value = draft;
        }
    }
}

document.getElementById('chat-input-text').addEventListener('input', saveDraft);
document.addEventListener('clubSelected', loadDraft);

// Clear draft on send (integrate with Block 2's send-message-btn)
document.getElementById('send-message-btn').addEventListener('click', () => {
    const currentClubId = localStorage.getItem('currentClubId');
    if (currentClubId) {
        localStorage.removeItem(`draft_${currentClubId}`);
    }
});

// Handle message read receipts
function markMessageRead(clubId, messageIndex) {
    if (!messageData[clubId]?.[messageIndex]) return;
    messageData[clubId][messageIndex].readBy = messageData[clubId][messageIndex].readBy || [];
    if (!messageData[clubId][messageIndex].readBy.some(m => m.id === currentUserId)) {
        messageData[clubId][messageIndex].readBy.push({ id: currentUserId, username: currentUsername });
        localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
        if (isSocketInitialized) {
            socketIO.emit('readMessage', { clubId, messageIndex, userId: currentUserId });
        }
        renderChatMessages(clubId);
    }
}

// Socket.IO read receipt handling
if (isSocketInitialized) {
    socketIO.on('readMessage', ({ clubId, messageIndex, userId }) => {
        if (messageData[clubId]?.[messageIndex]) {
            messageData[clubId][messageIndex].readBy = messageData[clubId][messageIndex].readBy || [];
            if (!messageData[clubId][messageIndex].readBy.some(m => m.id === userId)) {
                const user = clubData.find(c => c.id === clubId)?.members.find(m => m.id === userId);
                if (user) {
                    messageData[clubId][messageIndex].readBy.push({ id: userId, username: user.username });
                    localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
                    if (clubId === localStorage.getItem('currentClubId')) {
                        renderChatMessages(clubId);
                    }
                }
            }
        }
    });
}

// Handle message timestamps
function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('en-US', {
        hour: 'numeric',
        minute: 'numeric',
        hour12: true,
        month: 'short',
        day: 'numeric'
    });
}

// Handle message mentions
function parseMentions(text) {
    const mentionRegex = /@(\w+)/g;
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    if (!club) return sanitizeInput(text);

    return text.replace(mentionRegex, (match, username) => {
        const user = club.members.find(m => m.username.toLowerCase() === username.toLowerCase());
        if (user) {
            return `<span class="mention" onclick="viewProfile('${user.id}')">@${sanitizeInput(user.username)}</span>`;
        }
        return match;
    });
}

// View user profile
async function viewProfile(userId) {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    const user = club?.members.find(m => m.id === userId);
    let profileData = { username: user?.username || userId, joined: new Date().toISOString() };

    await safeExecute(async () => {
        const data = await apiRequest(`/api/users/${userId}`);
        profileData = { username: data.username, joined: data.joined || new Date().toISOString() };
    }, 'Failed to load user profile');

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'user-profile-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Profile</h3>
                <button class="neumorphic-btn" onclick="modalToggle('user-profile-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Username: ${sanitizeInput(profileData.username)}</p>
                <p>Member since: ${new Date(profileData.joined).toLocaleDateString()}</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('user-profile-modal', false);
    });
}

// Render chat messages
function renderChatMessages(clubId, messages = null) {
    const messagesEl = document.getElementById('chat-messages');
    if (!messagesEl) return;

    messageData[clubId] = JSON.parse(localStorage.getItem(`chat_${clubId}`)) || [];
    const clubMessages = messages || messageData[clubId];
    if (clubMessages.length === 0) {
        messagesEl.innerHTML = `<p class="text-center">No messages yet.</p>`;
        return;
    }

    const pinnedMessages = clubMessages.filter(msg => msg.pinned);
    const regularMessages = clubMessages.filter(msg => !msg.pinned);
    const sortedMessages = [...pinnedMessages, ...regularMessages];

    messagesEl.innerHTML = sortedMessages.map((msg, i) => {
        const reactions = msg.reactions
            ? Object.entries(msg.reactions).map(([emoji, count]) => `${emoji} ${count}`).join(' ')
            : '';
        const readBy = msg.readBy?.length ? `Read by ${msg.readBy.length} user(s)` : '';
        const timestamp = msg.timestamp ? formatTimestamp(msg.timestamp) : '';
        const text = parseMentions(sanitizeInput(msg.text));
        const isEdited = msg.isEdited ? '<span class="edited">(edited)</span>' : '';
        return `
            <div class="chat-message ${msg.senderId === currentUserId ? 'own' : ''} ${msg.pinned ? 'pinned' : ''}" data-message-id="${msg.id}" onclick="markMessageRead('${clubId}', ${i})">
                <span class="sender">${sanitizeInput(msg.sender)}</span>
                <p>${text} ${isEdited}</p>
                ${msg.image ? `<img src="${sanitizeInput(msg.image)}" alt="Image" width="200">` : ''}
                ${msg.video ? `<video src="${sanitizeInput(msg.video)}" controls width="200"></video>` : ''}
                ${reactions ? `<div class="reactions">${reactions}</div>` : ''}
                ${readBy ? `<div class="read-receipt">${readBy}</div>` : ''}
                ${timestamp ? `<div class="timestamp">${timestamp}</div>` : ''}
                ${msg.pinned ? `<span class="pinned-icon"><i class="fas fa-thumbtack"></i></span>` : ''}
                ${msg.senderId === currentUserId ? `
                    <span class="message-menu"><i class="fas fa-ellipsis-v"></i></span>
                    <div class="message-menu-content">
                        <div onclick="editMessage('${clubId}', ${i}, document.getElementById('edit-message-text').value)">Edit</div>
                        <div onclick="deleteMessage('${clubId}', ${i})">Delete</div>
                        <div onclick="addReaction('${clubId}', ${i}, '👍')">Add Reaction</div>
                        <div onclick="pinMessage('${clubId}', ${i})">${msg.pinned ? 'Unpin' : 'Pin'}</div>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');

    document.querySelectorAll('.message-menu').forEach(menu => {
        menu.addEventListener('click', (e) => {
            e.stopPropagation();
            const menuContent = e.target.nextElementSibling;
            document.querySelectorAll('.message-menu-content.active').forEach(content => {
                if (content !== menuContent) content.classList.remove('active');
            });
            if (menuContent) menuContent.classList.toggle('active');
        });
    });

    document.dispatchEvent(new Event('messagesRendered'));
}

// Handle visibility change to update user status
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        updateOnlineStatus();
    }
});

// CSS styles
const style = document.createElement('style');
style.textContent = `
    .chat-message.pinned {
        border-left: 4px solid var(--accent-color);
        background: var(--table-highlight);
    }
    .pinned-icon {
        position: absolute;
        top: 5px;
        left: 5px;
        color: var(--accent-color);
    }
    .read-receipt {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 5px;
    }
    .timestamp {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 5px;
        text-align: right;
    }
    .mention {
        color: var(--accent-color);
        cursor: pointer;
        font-weight: 600;
    }
    .mention:hover {
        text-decoration: underline;
    }
    .edited {
        font-size: 12px;
        color: var(--text-muted);
        margin-left: 5px;
    }
    .club-list.full-width {
        width: 100% !important;
    }
`;
document.head.appendChild(style);

function replyToMessage(clubId, messageIndex) {
    const message = messageData[clubId]?.find(m => m.id === messageIndex);
    if (!message) return;

    const chatInput = document.getElementById('chat-input-text');
    if (chatInput) {
        chatInput.value = `Replying to @${sanitizeInput(message.sender)}: `;
        chatInput.focus();
        chatInput.dataset.replyTo = messageIndex;
    }
}

document.getElementById('send-message-btn').addEventListener('click', async () => {
    const chatInput = document.getElementById('chat-input-text');
    const mediaInput = document.getElementById('chat-media-input');
    const currentClubId = localStorage.getItem('currentClubId');
    if (!chatInput || !currentClubId) {
        showNotification('Cannot send message. Missing input or club ID.', 'error');
        return;
    }
    const text = chatInput.value?.trim();
    const mediaFile = mediaInput?.files?.[0];
    if (!text && !mediaFile) {
        showNotification('Message or media is required.', 'error');
        return;
    }
    const replyTo = chatInput.dataset.replyTo || null;
    const message = {
        id: `msg-${Date.now()}`,
        senderId: currentUserId,
        sender: currentUsername,
        text: text || '',
        timestamp: new Date().toISOString(),
        replyTo,
        readBy: [{ id: currentUserId, username: currentUsername }]
    };

    if (mediaFile && validateFile(mediaFile)) {
        await safeExecute(async () => {
            const formData = new FormData();
            formData.append('file', mediaFile);
            const response = await apiRequest(`/api/upload`, {
                method: 'POST',
                body: formData,
                headers: {}
            });
            if (mediaFile.type.includes('image/')) {
                message.image = response.url;
            } else if (mediaFile.type.includes('video/')) {
                message.video = response.url;
            }
            if (isSocketInitialized) {
                socketIO.emit('message', { clubId: currentClubId, message });
            }
            saveMessage(currentClubId, message);
            renderChatMessages(currentClubId);
            chatInput.value = '';
            mediaInput.value = '';
            delete chatInput.dataset.replyTo;
            localStorage.removeItem(`draft_${currentClubId}`);
        }, 'Failed to upload media');
    } else if (text) {
        if (isSocketInitialized) {
            socketIO.emit('message', { clubId: currentClubId, message });
        }
        saveMessage(currentClubId, message);
        renderChatMessages(currentClubId);
        chatInput.value = '';
        delete chatInput.dataset.replyTo;
        localStorage.removeItem(`draft_${currentClubId}`);
    } else {
        showNotification('Invalid media file.', 'error');
        mediaInput.value = '';
    }
});

function renderChatMessages(clubId, messages = null) {
    const messagesEl = document.getElementById('chat-messages');
    if (!messagesEl) return;

    messageData[clubId] = JSON.parse(localStorage.getItem(`chat_${clubId}`)) || [];
    const clubMessages = messages || messageData[clubId];
    if (clubMessages.length === 0) {
        messagesEl.innerHTML = `<p class="text-center">No messages yet.</p>`;
        return;
    }

    const pinnedMessages = clubMessages.filter(msg => msg.pinned);
    const regularMessages = clubMessages.filter(msg => !msg.pinned);
    const sortedMessages = [...pinnedMessages, ...regularMessages];

    messagesEl.innerHTML = sortedMessages.map((msg, i) => {
        const reactions = msg.reactions
            ? Object.entries(msg.reactions).map(([emoji, count]) => `${emoji} ${count}`).join(' ')
            : '';
        const readBy = msg.readBy?.length ? `Read by ${msg.readBy.length} user(s)` : '';
        const timestamp = msg.timestamp ? formatTimestamp(msg.timestamp) : '';
        const text = parseMentions(sanitizeInput(msg.text));
        const isEdited = msg.isEdited ? '<span class="edited">(edited)</span>' : '';
        const replyTo = msg.replyTo && messageData[clubId].find(m => m.id === msg.replyTo)
            ? `<div class="reply-preview" onclick="highlightMessage('${clubId}', '${msg.replyTo}')">
                <span>${sanitizeInput(messageData[clubId].find(m => m.id === msg.replyTo).sender)}:</span>
                ${sanitizeInput(messageData[clubId].find(m => m.id === msg.replyTo).text.slice(0, 50)) + '...'}
               </div>`
            : '';
        return `
            <div class="chat-message ${msg.senderId === currentUserId ? 'own' : ''} ${msg.pinned ? 'pinned' : ''}" data-message-id="${msg.id}" onclick="markMessageRead('${clubId}', ${i})">
                <span class="sender">${sanitizeInput(msg.sender)}</span>
                ${replyTo}
                <p>${text} ${isEdited}</p>
                ${msg.image ? `<img src="${sanitizeInput(msg.image)}" alt="Image" width="200">` : ''}
                ${msg.video ? `<video src="${sanitizeInput(msg.video)}" controls width="200"></video>` : ''}
                ${reactions ? `<div class="reactions">${reactions}</div>` : ''}
                ${readBy ? `<div class="read-receipt">${readBy}</div>` : ''}
                ${timestamp ? `<div class="timestamp">${timestamp}</div>` : ''}
                ${msg.pinned ? `<span class="pinned-icon"><i class="fas fa-thumbtack"></i></span>` : ''}
                <span class="message-menu"><i class="fas fa-ellipsis-v"></i></span>
                <div class="message-menu-content">
                    ${msg.senderId === currentUserId ? `
                        <div onclick="openEditMessageModal('${clubId}', '${msg.id}')">Edit</div>
                        <div onclick="deleteMessage('${clubId}', ${i})">Delete</div>
                        <div onclick="deleteMessageForAll('${clubId}', ${i})">Delete for All</div>
                        <div onclick="addReaction('${clubId}', ${i}, '👍')">Add Reaction</div>
                        <div onclick="pinMessage('${clubId}', ${i})">${msg.pinned ? 'Unpin' : 'Pin'}</div>
                        <div onclick="replyToMessage('${clubId}', '${msg.id}')">Reply</div>
                        <div onclick="forwardMessage('${clubId}', ${i})">Forward</div>
                        ${msg.isEdited ? `<div onclick="viewEditHistory('${clubId}', '${msg.id}')">View Edit History</div>` : ''}
                    ` : `
                        <div onclick="addReaction('${clubId}', ${i}, '👍')">Add Reaction</div>
                        <div onclick="replyToMessage('${clubId}', '${msg.id}')">Reply</div>
                    `}
                </div>
            </div>
        `;
    }).join('');

    document.querySelectorAll('.message-menu').forEach(menu => {
        menu.addEventListener('click', (e) => {
            e.stopPropagation();
            const menuContent = e.target.nextElementSibling;
            document.querySelectorAll('.message-menu-content.active').forEach(content => {
                if (content !== menuContent) content.classList.remove('active');
            });
            if (menuContent) menuContent.classList.toggle('active');
        });
    });

    messagesEl.scrollTop = messagesEl.scrollHeight;
    document.dispatchEvent(new Event('messagesRendered'));
}

function openEditMessageModal(clubId, messageId) {
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!message || !message.text) {
        showNotification('Only text messages can be edited.', 'error');
        return;
    }
    const editForm = document.getElementById('edit-message-form');
    const editInput = document.getElementById('edit-message-text');
    if (!editForm || !editInput) return;

    editInput.value = message.text;
    editForm.dataset.messageId = messageId;
    modalToggle('edit-message-modal', true);
}

function editMessage(clubId, messageIndex, newText) {
    const message = messageData[clubId]?.[messageIndex];
    if (!message || !newText || newText === message.text) return;

    message.editHistory = message.editHistory || [];
    message.editHistory.push({
        text: message.text,
        timestamp: new Date().toISOString()
    });
    message.text = newText;
    message.isEdited = true;
    localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
    if (isSocketInitialized) {
        socketIO.emit('editMessage', { clubId, messageIndex, newText, editHistory: message.editHistory, isEdited: true });
    }
    renderChatMessages(clubId);
    showNotification('Message edited successfully!', 'success');
}

if (isSocketInitialized) {
    socketIO.on('editMessage', ({ clubId, messageIndex, newText, editHistory, isEdited }) => {
        if (messageData[clubId]?.[messageIndex]) {
            messageData[clubId][messageIndex].text = newText;
            messageData[clubId][messageIndex].editHistory = editHistory;
            messageData[clubId][messageIndex].isEdited = isEdited;
            localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
            if (clubId === localStorage.getItem('currentClubId')) {
                renderChatMessages(clubId);
            }
        }
    });
}

function highlightMessage(clubId, messageId) {
    const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
    if (messageEl) {
        messageEl.classList.add('highlighted');
        messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => messageEl.classList.remove('highlighted'), 2000);
    }
}

function forwardMessage(clubId, messageIndex) {
    const message = messageData[clubId]?.[messageIndex];
    if (!message) return;

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'forward-message-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Forward Message</h3>
                <button class="neumorphic-btn" onclick="modalToggle('forward-message-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Select a club to forward this message to:</p>
                <select id="forward-club-select">
                    ${clubData
                        .filter(c => c.members.some(m => m.id === currentUserId))
                        .map(c => `<option value="${c.id}">${sanitizeInput(c.name)}</option>`)
                        .join('')}
                </select>
                <div class="modal-buttons">
                    <button class="neumorphic-btn" onclick="modalToggle('forward-message-modal', false)">Cancel</button>
                    <button class="neumorphic-btn primary" onclick="confirmForwardMessage('${clubId}', ${messageIndex})">Forward</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('forward-message-modal', false);
    });
}

function confirmForwardMessage(clubId, messageIndex) {
    const select = document.getElementById('forward-club-select');
    const targetClubId = select.value;
    const message = messageData[clubId][messageIndex];
    if (!message || !targetClubId) return;

    const forwardedMessage = {
        id: `msg-${Date.now()}`,
        senderId: currentUserId,
        sender: currentUsername,
        text: `Forwarded from ${clubData.find(c => c.id === clubId)?.name}: ${message.text}`,
        image: message.image,
        video: message.video,
        timestamp: new Date().toISOString(),
        readBy: [{ id: currentUserId, username: currentUsername }]
    };

    safeExecute(async () => {
        await apiRequest(`/api/clubs/${targetClubId}/messages`, {
            method: 'POST',
            body: JSON.stringify(forwardedMessage)
        });
        saveMessage(targetClubId, forwardedMessage);
        if (isSocketInitialized) {
            socketIO.emit('message', { clubId: targetClubId, message: forwardedMessage });
        }
        if (targetClubId === localStorage.getItem('currentClubId')) {
            renderChatMessages(targetClubId);
        }
        showNotification('Message forwarded!', 'success');
        modalToggle('forward-message-modal', false);
    }, 'Failed to forward message');
}

function deleteMessageForAll(clubId, messageIndex) {
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to delete this message.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'delete-message-all-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Deletion</h3>
                <button class="neumorphic-btn" onclick="modalToggle('delete-message-all-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this message for all members? This action cannot be undone.</p>
                <div class="modal-buttons">
                    <button class="neumorphic-btn" onclick="modalToggle('delete-message-all-modal', false)">Cancel</button>
                    <button class="neumorphic-btn primary" onclick="confirmDeleteMessageForAll('${clubId}', ${messageIndex})">Delete</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('delete-message-all-modal', false);
    });
}

function confirmDeleteMessageForAll(clubId, messageIndex) {
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}/messages/${messageData[clubId][messageIndex].id}`, {
            method: 'DELETE'
        });
        messageData[clubId].splice(messageIndex, 1);
        localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
        if (isSocketInitialized) {
            socketIO.emit('deleteMessageForAll', { clubId, messageIndex });
        }
        renderChatMessages(clubId);
        showNotification('Message deleted for all.', 'success');
        modalToggle('delete-message-all-modal', false);
    }, 'Failed to delete message for all');
}

if (isSocketInitialized) {
    socketIO.on('deleteMessageForAll', ({ clubId, messageIndex }) => {
        if (messageData[clubId]?.[messageIndex]) {
            messageData[clubId].splice(messageIndex, 1);
            localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
            if (clubId === localStorage.getItem('currentClubId')) {
                renderChatMessages(clubId);
            }
        }
    });
}

function viewEditHistory(clubId, messageId) {
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!message?.editHistory?.length) {
        showNotification('No edit history available.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'edit-history-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit History</h3>
                <button class="neumorphic-btn" onclick="modalToggle('edit-history-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <ul>
                    ${message.editHistory.map((edit, i) => `
                        <li>
                            <p>Version ${i + 1}: ${sanitizeInput(edit.text)}</p>
                            <p>Edited at: ${formatTimestamp(edit.timestamp)}</p>
                        </li>
                    `).join('')}
                </ul>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('edit-history-modal', false);
    });
}

function updateMessageMenu() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    document.querySelectorAll('.chat-message .message-menu-content').forEach(menu => {
        const messageEl = menu.closest('.chat-message');
        const messageId = messageEl.dataset.messageId;
        const messageIndex = messageData[clubId].findIndex(m => m.id === messageId);
        if (messageIndex === -1) return;

        if (club.moderators.some(m => m.id === currentUserId) || club.creator.id === currentUserId) {
            const deleteAllOption = document.createElement('div');
            deleteAllOption.textContent = 'Delete for All';
            deleteAllOption.onclick = () => deleteMessageForAll(clubId, messageIndex);
            menu.appendChild(deleteAllOption);
        }

        if (messageData[clubId][messageIndex]?.isEdited) {
            const historyOption = document.createElement('div');
            historyOption.textContent = 'View Edit History';
            historyOption.onclick = () => viewEditHistory(clubId, messageId);
            menu.appendChild(historyOption);
        }
    });
}

document.addEventListener('messagesRendered', updateMessageMenu);

function manageMembers() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to manage members.', 'error');
        return;
    }

    let pendingInvites = [];
    safeExecute(async () => {
        pendingInvites = await apiRequest(`/api/clubs/${clubId}/pendingInvites`);
    }, 'Failed to load pending invitations');

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'club-members-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Club Members - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('club-members-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <h4>Members (${club.members.length})</h4>
                <ul>
                    ${club.members.map(member => `
                        <li>
                            ${sanitizeInput(member.username || member.id)}
                            ${club.creator.id === member.id ? '(Owner)' : ''}
                            ${club.moderators.some(m => m.id === member.id) ? '(Moderator)' : ''}
                            ${member.id !== currentUserId && (club.creator.id === currentUserId || club.moderators.some(m => m.id === currentUserId)) ? `
                                <button class="neumorphic-btn" onclick="toggleModerator('${sanitizeInput(clubId)}', '${sanitizeInput(member.id)}')">
                                    ${club.moderators.some(m => m.id === member.id) ? 'Remove Moderator' : 'Make Moderator'}
                                </button>
                                <button class="neumorphic-btn error" onclick="kickMember('${sanitizeInput(clubId)}', '${sanitizeInput(member.id)}')">Kick</button>
                            ` : ''}
                        </li>
                    `).join('')}
                </ul>
                <h4>Pending Invites</h4>
                <ul id="pending-invites-list">
                    ${pendingInvites.length > 0 ? pendingInvites.map(invite => `
                        <li>
                            ${sanitizeInput(invite.user?.username || invite.user?.id || invite.userId)}
                            <button class="neumorphic-btn primary" onclick="acceptInvite('${sanitizeInput(clubId)}', '${sanitizeInput(invite.userId)}')">Accept</button>
                            <button class="neumorphic-btn error" onclick="rejectInvite('${sanitizeInput(clubId)}', '${sanitizeInput(invite.userId)}')">Reject</button>
                        </li>
                    `).join('') : '<li>No pending invitations.</li>'}
                </ul>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('club-members-modal', false);
    });
}

function toggleModerator(clubId, userId) {
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    const isModerator = club.moderators.some(m => m.id === userId);
    if (isModerator) {
        club.moderators = club.moderators.filter(m => m.id !== userId);
    } else {
        club.moderators.push({ id: userId, username: club.members.find(m => m.id === userId)?.username || userId });
    }

    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}`, {
            method: 'PATCH',
            body: JSON.stringify({ moderators: club.moderators })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('moderatorToggled', { clubId, userId, isModerator: !isModerator });
        }
        showNotification(`User ${userId} ${isModerator ? 'demoted' : 'promoted'} to moderator!`, 'success');
        manageMembers();
    }, 'Failed to update moderator status');
}

function kickMember(clubId, userId) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'kick-member-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Kick</h3>
                <button class="neumorphic-btn" onclick="modalToggle('kick-member-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to kick ${sanitizeInput(userId)} from the club?</p>
                <div class="modal-buttons">
                    <button class="neumorphic-btn" onclick="modalToggle('kick-member-modal', false)">Cancel</button>
                    <button class="neumorphic-btn primary" onclick="confirmKickMember('${sanitizeInput(clubId)}', '${sanitizeInput(userId)}')">Kick</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('kick-member-modal', false);
    });
}

function confirmKickMember(clubId, userId) {
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.members = club.members.filter(m => m.id !== userId);
    club.moderators = club.moderators.filter(m => m.id !== userId);

    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}`, {
            method: 'PATCH',
            body: JSON.stringify({ members: club.members, moderators: club.moderators })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('memberKicked', { clubId, userId });
        }
        showNotification(`User ${userId} kicked from club!`, 'success');
        modalToggle('kick-member-modal', false);
        manageMembers();
    }, 'Failed to kick member');
}

function acceptInvite(clubId, userId) {
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}/invites/${userId}/accept`, { method: 'POST' });
        const club = clubData.find(c => c.id === clubId);
        if (club) {
            const user = club.pendingInvites?.find(i => i.userId === userId)?.user || { id: userId, username: userId };
            club.members.push({ id: userId, username: user.username });
            club.pendingInvites = club.pendingInvites?.filter(i => i.userId !== userId) || [];
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (isSocketInitialized) {
                socketIO.emit('joinClub', { clubId, userId });
            }
            showNotification(`Invite accepted for ${userId}!`, 'success');
            manageMembers();
        }
    }, 'Failed to accept invitation');
}

function rejectInvite(clubId, userId) {
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}/invites/${userId}/reject`, { method: 'POST' });
        const club = clubData.find(c => c.id === clubId);
        if (club) {
            club.pendingInvites = club.pendingInvites?.filter(i => i.userId !== userId) || [];
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            showNotification(`Invite rejected for ${userId}.`, 'success');
            manageMembers();
        }
    }, 'Failed to reject invitation');
}

if (isSocketInitialized) {
    socketIO.on('memberKicked', ({ clubId, userId }) => {
        const club = clubData.find(c => c.id === clubId);
        if (!club) return;

        if (userId === currentUserId) {
            clubData = clubData.filter(c => c.id !== clubId);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            localStorage.removeItem(`chat_${clubId}`);
            localStorage.removeItem('currentClubId');
            showNotification('You have been kicked from the club.', 'error');
            renderClub();
        } else {
            club.members = club.members.filter(m => m.id !== userId);
            club.moderators = club.moderators.filter(m => m.id !== userId);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (clubId === localStorage.getItem('currentClubId')) {
                loadClub(clubId);
            }
        }
    });
}

if (isSocketInitialized) {
    socketIO.on('moderatorToggled', ({ clubId, userId, isModerator }) => {
        const club = clubData.find(c => c.id === clubId);
        if (!club) return;

        if (isModerator) {
            const user = club.members.find(m => m.id === userId);
            if (user) club.moderators.push({ id: userId, username: user.username });
        } else {
            club.moderators = club.moderators.filter(m => m.id !== userId);
        }
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (clubId === localStorage.getItem('currentClubId')) {
            loadClub(clubId);
        }
    });
}

function sendClubNotification() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to send notifications.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'notification-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Send Club Notification</h3>
                <button class="neumorphic-btn" onclick="modalToggle('notification-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="notification-form">
                    <div class="form-group">
                        <label for="notification-message">Message</label>
                        <textarea id="notification-message" name="message" required></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button class="neumorphic-btn" onclick="modalToggle('notification-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('notification-modal', false);
    });

    document.getElementById('notification-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = document.getElementById('notification-message').value.trim();
        if (!message) return;

        await safeExecute(async () => {
            await apiRequest(`/api/clubs/${clubId}/notifications`, {
                method: 'POST',
                body: JSON.stringify({ message })
            });
            if (isSocketInitialized) {
                socketIO.emit('notificationSent', { clubId, message });
            }
            showNotification(`Notification sent: ${message}`, 'success');
            modalToggle('notification-modal', false);
        }, 'Failed to send club notification');
    });
}

if (isSocketInitialized) {
    socketIO.on('notificationSent', ({ clubId, message }) => {
        if (clubId === localStorage.getItem('currentClubId')) {
            showNotification(`Club Notification: ${message}`, 'success');
        }
    });
}

function viewAnalytics() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to view analytics.', 'error');
        return;
    }

    safeExecute(async () => {
        const analytics = await apiRequest(`/api/clubs/${clubId}/analytics`);
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.id = 'club-analytics-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Club Analytics - ${sanitizeInput(club.name)}</h3>
                    <button class="neumorphic-btn" onclick="modalToggle('club-analytics-modal', false)">Close</button>
                </div>
                <div class="modal-body">
                    <p>Active Members: ${analytics.activeMembers || 0}</p>
                    <p>Messages Sent (Last 30 days): ${analytics.messages || 0}</p>
                    <p>Joins (Last 7 days): ${analytics.joins || 0}</p>
                    <p>Leaves (Last 7 days): ${analytics.leaves || 0}</p>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay active';
        document.body.appendChild(overlay);
        overlay.addEventListener('click', () => {
            modalToggle('club-analytics-modal', false);
        });
    }, 'Failed to load analytics');
}

function createClubEvent() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to create events.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'club-event-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Event - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('club-event-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="event-form">
                    <div class="form-group">
                        <label for="event-title">Event Title</label>
                        <input type="text" id="event-title" name="title" placeholder="Event Name" required>
                    </div>
                    <div class="form-group">
                        <label for="event-date">Date and Time</label>
                        <input type="datetime-local" id="event-date" name="datetime" required>
                    </div>
                    <div class="form-group">
                        <label for="event-description">Description</label>
                        <textarea id="event-description" name="description" placeholder="Event description"></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button class="neumorphic-btn" onclick="modalToggle('club-event-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Create</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('club-event-modal', false);
    });

    document.getElementById('event-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('event-title').value.trim();
        const date = new Date(document.getElementById('event-date').value);
        const description = document.getElementById('event-description').value.trim();
        if (date < new Date()) {
            showNotification('Event date must be in the future.', 'error');
            return;
        }

        const event = {
            id: `event-${Date.now()}`,
            title,
            date: date.toISOString(),
            description,
            clubId,
            creatorId: currentUserId,
            attendees: [{ id: currentUserId, username: currentUsername }]
        };

        await safeExecute(async () => {
            const createdEvent = await apiRequest(`/api/clubs/${clubId}/events`, {
                method: 'POST',
                body: JSON.stringify(event)
            });
            if (isSocketInitialized) {
                socketIO.emit('eventCreated', { clubId, event: createdEvent });
            }
            showNotification('Event created successfully!', 'success');
            modalToggle('club-event-modal', false);
            displayEvents(clubId);
        }, 'Failed to create event');
    });
}

function displayEvents(clubId) {
    const clubInfoSection = document.getElementById('club-info-section');
    if (!clubInfoSection) return;

    safeExecute(async () => {
        const clubEvents = await apiRequest(`/api/clubs/${clubId}/events`);
        const existingEvents = clubInfoSection.querySelector('.club-events');
        if (existingEvents) existingEvents.remove();

        const eventsDiv = document.createElement('div');
        eventsDiv.className = 'club-events';
        eventsDiv.innerHTML = '<h4>Upcoming Events</h4>';

        if (clubEvents.length > 0) {
            eventsDiv.innerHTML += clubEvents.map(event => `
                <div class="event-item">
                    <h5>${sanitizeInput(event.title)}</h5>
                    <p>${formatTimestamp(new Date(event.date))}</p>
                    <p>${sanitizeInput(event.description || '')}</p>
                    <p>Attendees: ${event.attendees.length}</p>
                    <button class="neumorphic-btn attend-event-btn" onclick="toggleAttendEvent('${sanitizeInput(clubId)}', '${sanitizeInput(event.id)}')">
                        ${event.attendees.some(a => a.id === currentUserId) ? 'Leave Event' : 'Attend Event'}
                    </button>
                </div>
            `).join('');
        } else {
            eventsDiv.innerHTML += '<p>No upcoming events.</p>';
        }
        clubInfoSection.appendChild(eventsDiv);
    }, 'Failed to load club events');
}

function toggleAttendEvent(clubId, eventId) {
    safeExecute(async () => {
        const event = await apiRequest(`/api/clubs/${clubId}/events/${eventId}`);
        const isAttending = event.attendees.some(a => a.id === currentUserId);
        if (isAttending) {
            event.attendees = event.attendees.filter(a => a.id !== currentUserId);
        } else {
            event.attendees.push({ id: currentUserId, username: currentUsername });
        }
        await apiRequest(`/api/clubs/${clubId}/events/${eventId}`, {
            method: 'PATCH',
            body: JSON.stringify({ attendees: event.attendees })
        });
        if (isSocketInitialized) {
            socketIO.emit('eventAttendance', { clubId, eventId, userId: currentUserId, attending: !isAttending });
        }
        showNotification(isAttending ? 'You have left the event.' : 'You are attending the event!', 'success');
        displayEvents(clubId);
    }, 'Failed to update event attendance');
}

if (isSocketInitialized) {
    socketIO.on('eventAttendance', ({ clubId }) => {
        if (clubId === localStorage.getItem('currentClubId')) {
            displayEvents(clubId);
        }
    });
}

if (isSocketInitialized) {
    socketIO.on('eventCreated', ({ clubId }) => {
        if (clubId === localStorage.getItem('currentClubId')) {
            displayEvents(clubId);
        }
    });
}

function createPoll() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to create polls.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'poll-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Poll - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('poll-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="poll-form">
                    <div class="form-group">
                        <label for="poll-question">Question</label>
                        <input type="text" id="poll-question" name="question" required>
                    </div>
                    <div id="poll-options">
                        <div class="form-group">
                            <label for="option-1">Option 1</label>
                            <input type="text" id="option-1" name="options" required>
                        </div>
                        <div class="form-group">
                            <label for="option-2">Option 2</label>
                            <input type="text" id="option-2" name="options" required>
                        </div>
                    </div>
                    <button type="button" class="neumorphic-btn" onclick="addPollOption()">Add Option</button>
                    <div class="modal-buttons">
                        <button class="neumorphic-btn" onclick="modalToggle('poll-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Create Poll</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('poll-modal', false);
    });

    document.getElementById('poll-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const question = document.getElementById('poll-question').value.trim();
        const options = Array.from(document.querySelectorAll('#poll-options input')).map(input => input.value.trim()).filter(op => op);
        if (options.length < 2) {
            showNotification('At least two options are required.', 'error');
            return;
        }

        const poll = {
            id: `poll-${Date.now()}`,
            question,
            options: options.map(option => ({ text: option, votes: 0 })),
            clubId,
            creatorId: currentUserId,
            voters: []
        };

        await safeExecute(async () => {
            await apiRequest(`/api/clubs/${clubId}/polls`, {
                method: 'POST',
                body: JSON.stringify(poll)
            });
            if (isSocketInitialized) {
                socketIO.emit('pollCreated', { clubId, poll });
            }
            showNotification('Poll created successfully!', 'success');
            modalToggle('poll-modal', false);
            displayPolls(clubId);
        }, 'Failed to create poll');
    });
}

function addPollOption() {
    const pollOptions = document.getElementById('poll-options');
    const optionCount = pollOptions.querySelectorAll('.form-group').length + 1;
    const optionDiv = document.createElement('div');
    optionDiv.className = 'form-group';
    optionDiv.innerHTML = `
        <label for="option-${optionCount}">Option ${optionCount}</label>
        <input type="text" id="option-${optionCount}" name="options">
    `;
    pollOptions.appendChild(optionDiv);
}

function displayPolls(clubId) {
    const clubInfoSection = document.getElementById('club-info-section');
    if (!clubInfoSection) return;

    safeExecute(async () => {
        const polls = await apiRequest(`/api/clubs/${clubId}/polls`);
        const existingPolls = clubInfoSection.querySelector('.club-polls');
        if (existingPolls) existingPolls.remove();

        const pollsDiv = document.createElement('div');
        pollsDiv.className = 'club-polls';
        pollsDiv.innerHTML = '<h4>Active Polls</h4>';

        if (polls.length > 0) {
            pollsDiv.innerHTML += polls.map(poll => `
                <div class="poll-item">
                    <h5>${sanitizeInput(poll.question)}</h5>
                    ${poll.options.map((option, index) => `
                        <div class="poll-option">
                            <input type="radio" name="poll-${poll.id}" id="poll-${poll.id}-${index}"
                                   ${poll.voters.some(v => v.id === currentUserId) ? 'disabled' : ''}
                                   onclick="votePoll('${sanitizeInput(clubId)}', '${sanitizeInput(poll.id)}', ${index})">
                            <label for="poll-${poll.id}-${index}">${sanitizeInput(option.text)} (${option.votes})</label>
                        </div>
                    `).join('')}
                    <p>Total votes: ${poll.voters.length}</p>
                </div>
            `).join('');
        } else {
            pollsDiv.innerHTML += '<p>No active polls.</p>';
        }
        clubInfoSection.appendChild(pollsDiv);
    }, 'Failed to load polls');
}

function votePoll(clubId, pollId, optionIndex) {
    safeExecute(async () => {
        const poll = await apiRequest(`/api/clubs/${clubId}/polls/${pollId}`);
        if (poll.voters.some(v => v.id === currentUserId)) {
            showNotification('You have already voted in this poll.', 'error');
            return;
        }
        poll.options[optionIndex].votes += 1;
        poll.voters.push({ id: currentUserId, username: currentUsername });
        await apiRequest(`/api/clubs/${clubId}/polls/${pollId}`, {
            method: 'PATCH',
            body: JSON.stringify({ options: poll.options, voters: poll.voters })
        });
        if (isSocketInitialized) {
            socketIO.emit('pollVoted', { clubId, pollId, optionIndex, userId: currentUserId });
        }
        showNotification('Vote submitted!', 'success');
        displayPolls(clubId);
    }, 'Failed to submit vote');
}

if (isSocketInitialized) {
    socketIO.on('pollVoted', ({ clubId }) => {
        if (clubId === localStorage.getItem('currentClubId')) {
            displayPolls(clubId);
        }
    });
}

if (isSocketInitialized) {
    socketIO.on('pollCreated', ({ clubId }) => {
        if (clubId === localStorage.getItem('currentClubId')) {
            displayPolls(clubId);
        }
    });
}

function showMediaGallery() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club) {
        showNotification('Club not found.', 'error');
        return;
    }

    const clubMessages = messageData[clubId] || [];
    const mediaMessages = clubMessages.filter(m => m.image || m.video).slice(0, 20);

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'media-gallery-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Media Gallery - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('media-gallery-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <div class="media-gallery">
                    ${mediaMessages.length > 0 ? mediaMessages.map(msg => `
                        <div class="media-item">
                            ${msg.image ? `<img src="${sanitizeInput(msg.image)}" alt="Club media" class="media-image">` : ''}
                            ${msg.video ? `<video src="${sanitizeInput(msg.video)}" controls class="media-video"></video>` : ''}
                            <p>Posted by ${sanitizeInput(msg.sender)} on ${formatTimestamp(msg.timestamp)}</p>
                        </div>
                    `).join('') : '<p>No media available.</p>'}
                    ${mediaMessages.length >= 20 ? '<p>Showing first 20 items. More media available.</p>' : ''}
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('media-gallery-modal', false);
    });
}

function manageTags() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to manage tags.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'tags-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Tags - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('tags-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-tag">Add New Tag</label>
                    <input type="text" id="new-tag" placeholder="Enter tag name">
                    <button class="neumorphic-btn" onclick="addTag('${sanitizeInput(clubId)}')">Add Tag</button>
                </div>
                <h4>Current Tags:</h4>
                <ul id="tag-list">
                    ${club.tags?.length > 0 ? club.tags.map(tag => `
                        <li>
                            ${sanitizeInput(tag)}
                            <button class="neumorphic-btn error" onclick="removeTag('${sanitizeInput(clubId)}', '${sanitizeInput(tag)}')">Remove</button>
                        </li>
                    `).join('') : '<p>No tags yet.</p>'}
                </ul>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => {
        modalToggle('tags-modal', false);
    });
}

function addTag(clubId) {
    const input = document.getElementById('new-tag');
    const tag = input.value.trim();
    if (!tag) {
        showNotification('Tag name cannot be empty.', 'error');
        return;
    }

    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.tags = club.tags || [];
    if (!club.tags.includes(tag)) {
        safeExecute(async () => {
            club.tags.push(tag);
            await apiRequest(`/api/clubs/${clubId}`, {
                method: 'PATCH',
                body: JSON.stringify({ tags: club.tags })
            });
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            showNotification(`Tag "${tag}" added!`, 'success');
            manageTags();
        }, 'Failed to add tag');
    } else {
        showNotification('Tag already exists.', 'error');
    }
}

function removeTag(clubId, tag) {
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.tags = club.tags.filter(t => t !== tag);
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}`, {
            method: 'PATCH',
            body: JSON.stringify({ tags: club.tags })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        showNotification(`Tag "${tag}" removed!`, 'success');
        manageTags();
    }, 'Failed to remove tag');
}

function searchClubs(query) {
    const filteredClubs = query ? clubData.filter(club =>
        club.name.toLowerCase().includes(query.toLowerCase()) ||
        club.description?.toLowerCase().includes(query.toLowerCase()) ||
        club.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
    ) : clubData;
    renderClub(filteredClubs);
}

const dropdownOptions = [
    { text: 'Manage Members', onclick: manageMembers },
    { text: 'Send Notification', onclick: sendClubNotification },
    { text: 'View Analytics', onclick: viewAnalytics },
    { text: 'Create Event', onclick: createClubEvent },
    { text: 'Create Poll', onclick: createPoll },
    { text: 'Media Gallery', onclick: showMediaGallery },
    { text: 'Manage Tags', onclick: manageTags }
];

dropdownOptions.forEach(option => {
    const el = document.createElement('div');
    el.textContent = option.text;
    el.onclick = option.onclick;
    el.setAttribute('role', 'button');
    el.setAttribute('aria-label', option.text);
    document.querySelector('.dropdown-content').appendChild(el);
});

document.querySelector('style').textContent += `
    .reply-preview {
        background: var(--bg-light);
        border-left: 2px solid var(--accent-color);
        padding: 10px;
        margin-bottom: 5px;
        font-size: 12px;
        cursor: pointer;
        border-radius: 4px;
    }
    .reply-preview span {
        font-weight: 600;
        color: var(--accent-color);
    }
    .reply-preview:hover {
        background: var(--hover-color);
    }
    .chat-message.highlighted {
        background: var(--highlight-color);
        animation: highlight 2s ease-out;
    }
    @keyframes highlight {
        from { background: var(--accent-color); }
        to { background: var(--highlight-color); }
    }
    .tag {
        background: var(--primary-color);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        margin-right: 5px;
        font-size: 12px;
    }
    .attend-event-btn {
        margin-top: 5px;
    }
    .poll-item {
        margin-bottom: 20px;
        padding-bottom: 1px solid var(--border-color);
    }
    .media-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    .media-image, .media-video {
        max-width: 100%;
        border-radius: 8px;
    }
    .event-item, .poll-item {
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 10px;
    }
`;

userData.notifications = userData.notifications || { enabled: true, sound: false };
userData.bookmarks = userData.bookmarks || [];

function openUserSettings() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'user-settings-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Settings</h3>
                <button class="neumorphic-btn" onclick="modalToggle('user-settings-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="user-settings-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" value="${sanitizeInput(currentUsername)}" required>
                    </div>
                    <div class="form-group">
                        <label for="profile-pic">Profile Picture</label>
                        <input type="file" id="profile-pic" name="profile-pic" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label for="bio">Bio</label>
                        <textarea id="bio" name="bio">${sanitizeInput(userData.bio || '')}</textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('user-settings-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('user-settings-modal', false));

    document.getElementById('user-settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const bio = document.getElementById('bio').value.trim();
        const profilePic = document.getElementById('profile-pic').files[0];

        if (username !== currentUsername) {
            const usernameCheck = await apiRequest(`/api/users/check-username`, {
                method: 'POST',
                body: JSON.stringify({ username })
            });
            if (!usernameCheck.available) {
                showNotification('Username is already taken.', 'error');
                return;
            }
        }

        await safeExecute(async () => {
            const updates = { username, bio };
            if (profilePic && validateFile(profilePic)) {
                const formData = new FormData();
                formData.append('file', profilePic);
                const response = await apiRequest(`/api/upload`, {
                    method: 'POST',
                    body: formData,
                    headers: {}
                });
                updates.profilePic = response.url;
            }
            await apiRequest(`/api/users/${currentUserId}`, {
                method: 'PATCH',
                body: JSON.stringify(updates)
            });
            currentUsername = username;
            userData.bio = bio;
            if (updates.profilePic) userData.profilePic = updates.profilePic;
            localStorage.setItem(`user_${currentUserId}`, JSON.stringify(userData));
            showNotification('Profile updated!', 'success');
            modalToggle('user-settings-modal', false);
        }, 'Failed to update profile.');
    });
}

if (dropdownContent) {
    const settingsOption = document.createElement('div');
    settingsOption.textContent = 'User Settings';
    settingsOption.onclick = openUserSettings;
    settingsOption.setAttribute('role', 'button');
    settingsOption.setAttribute('aria-label', 'User Settings');
    dropdownContent.appendChild(settingsOption);
}

function openNotificationSettings() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'notification-settings-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Notification Settings</h3>
                <button class="neumorphic-btn" onclick="modalToggle('notification-settings-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="notification-settings-form">
                    <div class="form-group">
                        <label for="enable-notifications">Enable Notifications</label>
                        <input type="checkbox" id="enable-notifications" name="enable-notifications" ${userData.notifications.enabled ? 'checked' : ''}>
                    </div>
                    <div class="form-group">
                        <label for="sound-notifications">Sound Notifications</label>
                        <input type="checkbox" id="sound-notifications" name="sound-notifications" ${userData.notifications.sound ? 'checked' : ''}>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('notification-settings-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('notification-settings-modal', false));

    document.getElementById('notification-settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const enabled = document.getElementById('enable-notifications').checked;
        const sound = document.getElementById('sound-notifications').checked;

        await safeExecute(async () => {
            userData.notifications = { enabled, sound };
            await apiRequest(`/api/users/${currentUserId}`, {
                method: 'PATCH',
                body: JSON.stringify({ notifications: userData.notifications })
            });
            localStorage.setItem(`user_${currentUserId}`, JSON.stringify(userData));
            showNotification('Notification settings updated!', 'success');
            modalToggle('notification-settings-modal', false);
        }, 'Failed to update notification settings.');
    });
}

if (dropdownContent) {
    const notificationSettingsOption = document.createElement('div');
    notificationSettingsOption.textContent = 'Notification Settings';
    notificationSettingsOption.onclick = openNotificationSettings;
    notificationSettingsOption.setAttribute('role', 'button');
    notificationSettingsOption.setAttribute('aria-label', 'Notification Settings');
    dropdownContent.appendChild(notificationSettingsOption);
}

function toggleClubMute() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.muted = !club.muted;
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}`, {
            method: 'PATCH',
            body: JSON.stringify({ muted: club.muted })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        showNotification(club.muted ? 'Club muted.' : 'Club unmuted.', 'success');
    }, 'Failed to update mute status.');
}

if (dropdownContent) {
    const muteOption = document.createElement('div');
    muteOption.textContent = 'Toggle Mute';
    muteOption.onclick = toggleClubMute;
    muteOption.setAttribute('role', 'button');
    muteOption.setAttribute('aria-label', 'Toggle Mute');
    dropdownContent.appendChild(muteOption);
}

function leaveClub() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || club.creator.id === currentUserId) {
        showNotification('You cannot leave a club you created.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'leave-club-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Leave</h3>
                <button class="neumorphic-btn" onclick="modalToggle('leave-club-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to leave ${sanitizeInput(club.name)}? This action cannot be undone.</p>
                <div class="modal-buttons">
                    <button class="neumorphic-btn" onclick="modalToggle('leave-club-modal', false)">Cancel</button>
                    <button class="neumorphic-btn primary" onclick="confirmLeaveClub('${sanitizeInput(clubId)}')">Leave</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('leave-club-modal', false));
}

function confirmLeaveClub(clubId) {
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.members = club.members.filter(m => m.id !== currentUserId);
    club.moderators = club.moderators.filter(m => m.id !== currentUserId);

    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}`, {
            method: 'PATCH',
            body: JSON.stringify({ members: club.members, moderators: club.moderators })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('leaveClub', { clubId, userId: currentUserId });
        }
        localStorage.removeItem('currentClubId');
        localStorage.removeItem(`chat_${clubId}`);
        renderClub();
        showNotification('You have left the club.', 'success');
        modalToggle('leave-club-modal', false);
    }, 'Failed to leave club.');
}

if (isSocketInitialized) {
    socketIO.on('leaveClub', ({ clubId, userId }) => {
        const club = clubData.find(c => c.id === clubId);
        if (!club) return;

        club.members = club.members.filter(m => m.id !== userId);
        club.moderators = club.moderators.filter(m => m.id !== userId);
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (clubId === localStorage.getItem('currentClubId') && userId === currentUserId) {
            localStorage.removeItem('currentClubId');
            localStorage.removeItem(`chat_${clubId}`);
            renderClub();
        }
    });
}

if (dropdownContent) {
    const leaveOption = document.createElement('div');
    leaveOption.textContent = 'Leave Club';
    leaveOption.onclick = leaveClub;
    leaveOption.setAttribute('role', 'button');
    leaveOption.setAttribute('aria-label', 'Leave Club');
    dropdownContent.appendChild(leaveOption);
}

function deleteClub() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || club.creator.id !== currentUserId) {
        showNotification('Only the club creator can delete the club.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'delete-club-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="neumorphic-btn" onclick="modalToggle('delete-club-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete ${sanitizeInput(club.name)}? This action cannot be undone.</p>
                <div class="modal-buttons">
                    <button class="neumorphic-btn" onclick="modalToggle('delete-club-modal', false)">Cancel</button>
                    <button class="neumorphic-btn primary" onclick="confirmDeleteClub('${sanitizeInput(clubId)}')">Delete</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('delete-club-modal', false));
}

function confirmDeleteClub(clubId) {
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}`, { method: 'DELETE' });
        clubData = clubData.filter(c => c.id !== clubId);
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        localStorage.removeItem(`chat_${clubId}`);
        localStorage.removeItem('currentClubId');
        if (isSocketInitialized) {
            socketIO.emit('clubDeleted', { clubId });
        }
        renderClub();
        showNotification('Club deleted.', 'success');
        modalToggle('delete-club-modal', false);
    }, 'Failed to delete club.');
}

if (dropdownContent) {
    const deleteOption = document.createElement('div');
    deleteOption.textContent = 'Delete Club';
    deleteOption.onclick = deleteClub;
    deleteOption.setAttribute('role', 'button');
    deleteOption.setAttribute('aria-label', 'Delete Club');
    dropdownContent.appendChild(deleteOption);
}

setInterval(() => {
    const clubId = localStorage.getItem('currentClubId');
    if (clubId && messageData[clubId]) {
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
        messageData[clubId] = messageData[clubId].filter(msg => new Date(msg.timestamp) > oneMonthAgo);
        localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
        if (clubId === localStorage.getItem('currentClubId')) {
            renderChatMessages(clubId);
        }
    }
}, 24 * 60 * 60 * 1000);

async function requestNotificationPermission() {
    if (Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
    }
    return Notification.permission === 'granted';
}

function showBrowserNotification(title, body) {
    if (userData.notifications?.enabled && Notification.permission === 'granted') {
        const notification = new Notification(title, { body });
        if (userData.notifications.sound) {
            const sound = new Audio('/assets/notification.mp3');
            sound.play().catch(() => console.warn('Failed to play notification sound.'));
        }
    }
}

if (isSocketInitialized) {
    socketIO.on('message', ({ clubId, message }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club && !club.muted && clubId !== localStorage.getItem('currentClubId')) {
            requestNotificationPermission().then(granted => {
                if (granted) showBrowserNotification(`New Message in ${club.name}`, message.text);
            });
        }
    });
}

function initEmojiPicker() {
    const chatInput = document.getElementById('chat-input-text');
    if (!chatInput) return;

    const emojiBtn = document.createElement('button');
    emojiBtn.className = 'neumorphic-btn';
    emojiBtn.innerHTML = '😊';
    emojiBtn.onclick = () => {
        const existingPicker = document.querySelector('.emoji-picker');
        if (existingPicker) existingPicker.remove();
        const picker = document.createElement('div');
        picker.className = 'emoji-picker';
        picker.innerHTML = `
            <span onclick="addEmoji('😊')">😊</span>
            <span onclick="addEmoji('😂')">😂</span>
            <span onclick="addEmoji('❤️')">❤️</span>
            <span onclick="addEmoji('👍')">👍</span>
            <span onclick="addEmoji('😢')">😢</span>
            <span onclick="addEmoji('😮')">😮</span>
        `;
        chatInput.parentElement.appendChild(picker);
        document.addEventListener('click', (e) => {
            if (!picker.contains(e.target) && e.target !== emojiBtn) {
                picker.remove();
            }
        }, { once: true });
    };
    chatInput.parentElement.appendChild(emojiBtn);
}

function addEmoji(emoji) {
    const chatInput = document.getElementById('chat-input-text');
    if (chatInput) {
        chatInput.value += emoji;
        chatInput.focus();
        document.querySelector('.emoji-picker')?.remove();
    }
}

initEmojiPicker();

let typingTimeout;
let lastTypingTime = 0;
function sendTypingStatus() {
    const clubId = localStorage.getItem('currentClubId');
    const now = Date.now();
    if (isSocketInitialized && clubId && now - lastTypingTime > 500) {
        socketIO.emit('typing', { clubId, userId: currentUserId });
        lastTypingTime = now;
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socketIO.emit('stopTyping', { clubId, userId: currentUserId });
        }, 3000);
    }
}

const chatInput = document.getElementById('chat-input-text');
if (chatInput) chatInput.addEventListener('input', sendTypingStatus);

if (isSocketInitialized) {
    socketIO.on('typing', ({ clubId, userId }) => {
        if (clubId === localStorage.getItem('currentClubId') && userId !== currentUserId) {
            const club = clubData.find(c => c.id === clubId);
            const username = club?.members.find(m => m.id === userId)?.username || 'Someone';
            const typingIndicator = document.getElementById('typing-indicator') || document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.textContent = `${sanitizeInput(username)} is typing...`;
            document.querySelector('.chat-section').appendChild(typingIndicator);
        }
    });

    socketIO.on('stopTyping', ({ clubId }) => {
        if (clubId === localStorage.getItem('currentClubId')) {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();
        }
    });
}

function cleanupDrafts() {
    const clubId = localStorage.getItem('currentClubId');
    if (clubId) localStorage.removeItem(`draft_${clubId}`);
}

let offlineMessageQueue = JSON.parse(localStorage.getItem('offlineMessageQueue') || '[]');
function queueMessage(clubId, message) {
    offlineMessageQueue.push({ clubId, message });
    localStorage.setItem('offlineMessageQueue', JSON.stringify(offlineMessageQueue));
}

function processOfflineQueue() {
    if (navigator.onLine && isSocketInitialized) {
        offlineMessageQueue.forEach(({ clubId, message }) => {
            socketIO.emit('message', { clubId, message });
            saveMessage(clubId, message);
            if (clubId === localStorage.getItem('currentClubId')) {
                renderChatMessages(clubId);
            }
        });
        offlineMessageQueue = [];
        localStorage.setItem('offlineMessageQueue', JSON.stringify(offlineMessageQueue));
    }
}

window.addEventListener('online', processOfflineQueue);

document.getElementById('send-message-btn').addEventListener('click', async () => {
    const chatInput = document.getElementById('chat-input-text');
    const mediaInput = document.getElementById('chat-media-input');
    const currentClubId = localStorage.getItem('currentClubId');
    if (!chatInput || !currentClubId) {
        showNotification('Cannot send message. Missing input or club ID.', 'error');
        return;
    }
    const text = chatInput.value?.trim();
    const mediaFile = mediaInput?.files?.[0];
    if (!text && !mediaFile) {
        showNotification('Message or media is required.', 'error');
        return;
    }
    const replyTo = chatInput.dataset.replyTo || null;
    const message = {
        id: `msg-${Date.now()}`,
        senderId: currentUserId,
        sender: currentUsername,
        text: text || '',
        timestamp: new Date().toISOString(),
        replyTo,
        readBy: [{ id: currentUserId, username: currentUsername }],
        attachments: []
    };

    if (mediaFile && validateFile(mediaFile)) {
        await safeExecute(async () => {
            const formData = new FormData();
            formData.append('file', mediaFile);
            const response = await apiRequest(`/api/upload`, {
                method: 'POST',
                body: formData,
                headers: {}
            });
            if (mediaFile.type.includes('image/')) {
                message.image = response.url;
            } else if (mediaFile.type.includes('video/')) {
                message.video = response.url;
            } else {
                message.attachments.push({ name: mediaFile.name, url: response.url, type: mediaFile.type });
            }
            if (navigator.onLine && isSocketInitialized) {
                socketIO.emit('message', { clubId: currentClubId, message });
                saveMessage(currentClubId, message);
                renderChatMessages(currentClubId);
            } else {
                queueMessage(currentClubId, message);
                saveMessage(currentClubId, message);
                renderChatMessages(currentClubId);
                showNotification('Message queued. Will send when online.', 'success');
            }
            chatInput.value = '';
            mediaInput.value = '';
            delete chatInput.dataset.replyTo;
            cleanupDrafts();
        }, 'Failed to upload media');
    } else if (text) {
        if (navigator.onLine && isSocketInitialized) {
            socketIO.emit('message', { clubId: currentClubId, message });
            saveMessage(currentClubId, message);
            renderChatMessages(currentClubId);
        } else {
            queueMessage(currentClubId, message);
            saveMessage(currentClubId, message);
            renderChatMessages(currentClubId);
            showNotification('Message queued. Will send when online.', 'success');
        }
        chatInput.value = '';
        delete chatInput.dataset.replyTo;
        cleanupDrafts();
    } else {
        showNotification('Invalid media file.', 'error');
        mediaInput.value = '';
    }
});

function manageCategories() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to manage categories.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'categories-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Categories - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('categories-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-category">Add New Category</label>
                    <input type="text" id="new-category" placeholder="Enter category name">
                    <button class="neumorphic-btn" onclick="addCategory('${sanitizeInput(clubId)}')">Add Category</button>
                </div>
                <h4>Current Categories:</h4>
                <ul id="category-list">
                    ${club.categories?.length ? club.categories.map(category => `
                        <li>
                            ${sanitizeInput(category)}
                            <button class="neumorphic-btn error" onclick="removeCategory('${sanitizeInput(clubId)}', '${sanitizeInput(category)}')">Remove</button>
                        </li>
                    `).join('') : '<p>No categories yet.</p>'}
                </ul>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('categories-modal', false));
}

function addCategory(clubId) {
    const input = document.getElementById('new-category');
    const category = input.value.trim();
    if (!category) {
        showNotification('Category name cannot be empty.', 'error');
        return;
    }

    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.categories = club.categories || [];
    if (!club.categories.includes(category)) {
        safeExecute(async () => {
            club.categories.push(category);
            await apiRequest(`/api/clubs/${clubId}`, {
                method: 'PATCH',
                body: JSON.stringify({ categories: club.categories })
            });
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            showNotification(`Category "${category}" added!`, 'success');
            updateCategoryFilter();
            manageCategories();
        }, 'Failed to add category.');
    } else {
        showNotification('Category already exists.', 'error');
    }
}

function removeCategory(clubId, category) {
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.categories = club.categories.filter(c => c !== category);
    messageData[clubId]?.forEach(msg => {
        if (msg.categories) msg.categories = msg.categories.filter(c => c !== category);
    });

    safeExecute(async () => {
        await apiRequest(`/api/clubs/${clubId}`, {
            method: 'PATCH',
            body: JSON.stringify({ categories: club.categories })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
        showNotification(`Category "${category}" removed!`, 'success');
        updateCategoryFilter();
        manageCategories();
        renderChatMessages(clubId);
    }, 'Failed to remove category.');
}

if (dropdownContent) {
    const categoriesOption = document.createElement('div');
    categoriesOption.textContent = 'Manage Categories';
    categoriesOption.onclick = manageCategories;
    categoriesOption.setAttribute('role', 'button');
    categoriesOption.setAttribute('aria-label', 'Manage Categories');
    dropdownContent.appendChild(categoriesOption);
}

function updateClubInfo() {
    const currentClubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === currentClubId);
    const clubInfoSection = document.getElementById('club-info-section');
    if (club && clubInfoSection) {
        clubInfoSection.innerHTML = `
            <img src="${sanitizeInput(club.image || '/assets/default-image.jpg')}" alt="${sanitizeInput(club.name)}" width="200" />
            <h2>${sanitizeInput(club.name)}</h2>
            <p>${sanitizeInput(club.description || 'No description provided.')}</p>
            <p>Type: ${sanitizeInput(club.type.charAt(0).toUpperCase() + club.type.slice(1))}</p>
            <p>Members: ${club.members.length}</p>
            <p>Online: ${club.online || 0}</p>
            <p>Created by: ${sanitizeInput(club.creator?.username || 'Unknown')}</p>
            <p class="membership-status">
                Status: ${club.members.some(m => m.id === currentUserId) ? 'Member' : 'Not a Member'}
            </p>
            ${club.tags?.length ? `
                <p>Tags: ${club.tags.map(tag => `<span class="tag">${sanitizeInput(tag)}</span>`).join(' ')}</p>
            ` : ''}
            ${club.categories?.length ? `
                <p>Categories: ${club.categories.map(category => `<span class="category">${sanitizeInput(category)}</span>`).join(' ')}</p>
            ` : ''}
        `;
        displayEvents(currentClubId);
        displayPolls(currentClubId);
    }
}

function addMessageCategory(clubId, messageId, category) {
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!message) return;

    message.categories = message.categories || [];
    if (!message.categories.includes(category)) {
        safeExecute(async () => {
            message.categories.push(category);
            await apiRequest(`/api/clubs/${clubId}/messages/${messageId}`, {
                method: 'PATCH',
                body: JSON.stringify({ categories: message.categories })
            });
            localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
            if (isSocketInitialized) {
                socketIO.emit('messageCategory', { clubId, messageId, category });
            }
            renderChatMessages(clubId);
            showNotification(`Category "${category}" added to message.`, 'success');
        }, 'Failed to add message category.');
    }
}

if (isSocketInitialized) {
    socketIO.on('messageCategory', ({ clubId, messageId, category }) => {
        const message = messageData[clubId]?.find(m => m.id === messageId);
        if (message) {
            message.categories = message.categories || [];
            if (!message.categories.includes(category)) {
                message.categories.push(category);
                localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
                if (clubId === localStorage.getItem('currentClubId')) {
                    renderChatMessages(clubId);
                }
            }
        }
    });
}

function addCategoryMenu(clubId, messageId) {
    const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
    if (!messageEl) return;

    const menuContent = messageEl.querySelector('.message-menu-content');
    if (menuContent) {
        const club = clubData.find(c => c.id === clubId);
        if (club?.categories?.length) {
            const categoryDiv = document.createElement('div');
            categoryDiv.textContent = 'Add Category';
            const categorySubmenu = document.createElement('div');
            categorySubmenu.className = 'submenu';
            club.categories.forEach(category => {
                const option = document.createElement('div');
                option.textContent = category;
                option.onclick = () => addMessageCategory(clubId, messageId, category);
                categorySubmenu.appendChild(option);
            });
            categoryDiv.appendChild(categorySubmenu);
            menuContent.appendChild(categoryDiv);
        }
    }
}

function searchMessagesByCategory(category) {
    const currentClubId = localStorage.getItem('currentClubId');
    if (!messageData[currentClubId]) return;

    const filteredMessages = messageData[currentClubId].filter(msg => msg.categories?.includes(category));
    renderChatMessages(currentClubId, filteredMessages);
}

const chatSection = document.querySelector('.chat-section');
if (chatSection) {
    const existingFilter = chatSection.querySelector('.category-filter');
    if (existingFilter) existingFilter.remove();
    const categoryFilter = document.createElement('select');
    categoryFilter.className = 'neumorphic-btn category-filter';
    categoryFilter.innerHTML = '<option value="">All Messages</option>';
    chatSection.prepend(categoryFilter);

    categoryFilter.addEventListener('change', (e) => {
        if (e.target.value) {
            searchMessagesByCategory(e.target.value);
        } else {
            renderChatMessages(localStorage.getItem('currentClubId'));
        }
    });
}

function updateCategoryFilter() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    const categoryFilter = document.querySelector('.category-filter');
    if (club && categoryFilter) {
        categoryFilter.innerHTML = '<option value="">All Messages</option>' + (club.categories?.length ? club.categories.map(c =>
            `<option value="${sanitizeInput(c)}">${sanitizeInput(c)}</option>`
        ).join('') : '');
    }
}

document.addEventListener('clubSelected', updateCategoryFilter);

function bookmarkMessage(clubId, messageId) {
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!message) return;

    const bookmark = { clubId, messageId };
    const bookmarkKey = `${clubId}:${messageId}`;
    if (!userData.bookmarks.some(b => `${b.clubId}:${b.messageId}` === bookmarkKey)) {
        userData.bookmarks.push(bookmark);
        showNotification('Message bookmarked!', 'success');
    } else {
        userData.bookmarks = userData.bookmarks.filter(b => `${b.clubId}:${b.messageId}` !== bookmarkKey);
        showNotification('Message unbookmarked.', 'success');
    }
    localStorage.setItem(`user_${currentUserId}`, JSON.stringify(userData));
    if (isSocketInitialized) {
        socketIO.emit(userData.bookmarks.some(b => `${b.clubId}:${b.messageId}` === bookmarkKey) ? 'bookmarkMessage' : 'unbookmarkMessage', { clubId, messageId, userId: currentUserId });
    }
    renderChatMessages(clubId);
}

if (isSocketInitialized) {
    socketIO.on('bookmarkMessage', ({ clubId, messageId, userId }) => {
        if (userId === currentUserId && clubId === localStorage.getItem('currentClubId')) {
            renderChatMessages(clubId);
        }
    });

    socketIO.on('unbookmarkMessage', ({ clubId, messageId, userId }) => {
        if (userId === currentUserId && clubId === localStorage.getItem('currentClubId')) {
            renderChatMessages(clubId);
        }
    });
}

function addBookmarkMenu(clubId, messageId) {
    const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
    if (!messageEl) return;

    const menuContent = messageEl.querySelector('.message-menu-content');
    if (menuContent) {
        const bookmarkDiv = document.createElement('div');
        const isBookmarked = userData.bookmarks?.some(b => b.clubId === clubId && b.messageId === messageId);
        bookmarkDiv.textContent = isBookmarked ? 'Remove Bookmark' : 'Bookmark';
        bookmarkDiv.onclick = () => bookmarkMessage(clubId, messageId);
        menuContent.appendChild(bookmarkDiv);
    }
}

function viewBookmarks() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'bookmarks-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bookmarked Messages</h3>
                <button class="neumorphic-btn" onclick="modalToggle('bookmarks-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                ${userData.bookmarks?.length ? userData.bookmarks.map(b => {
                    const message = messageData[b.clubId]?.find(m => m.id === b.messageId);
                    const club = clubData.find(c => c.id === b.clubId);
                    if (message && club) {
                        return `
                            <div class="bookmark-item" onclick="goToMessage('${sanitizeInput(b.clubId)}', '${sanitizeInput(b.messageId)}')">
                                <p><strong>${sanitizeInput(club.name)}</strong>: ${sanitizeInput(message.text.slice(0, 50))}...</p>
                                <p>${formatTimestamp(message.timestamp)}</p>
                            </div>
                        `;
                    }
                    return '';
                }).join('') : '<p>No bookmarked messages.</p>'}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('bookmarks-modal', false));
}

function goToMessage(clubId, messageId) {
    loadClub(clubId);
    setTimeout(() => {
        highlightMessage(clubId, messageId);
    }, 500);
}

if (dropdownContent) {
    const bookmarksOption = document.createElement('div');
    bookmarksOption.textContent = 'View Bookmarks';
    bookmarksOption.onclick = viewBookmarks;
    bookmarksOption.setAttribute('role', 'button');
    bookmarksOption.setAttribute('aria-label', 'View Bookmarks');
    dropdownContent.appendChild(bookmarksOption);
}

function addReactionPicker(clubId, messageId) {
    const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
    if (!messageEl) return;

    const menuContent = messageEl.querySelector('.message-menu-content');
    if (menuContent) {
        const reactionDiv = document.createElement('div');
        reactionDiv.textContent = 'Add Reaction';
        const reactionSubmenu = document.createElement('div');
        reactionSubmenu.className = 'submenu';
        const reactions = ['👍', '❤️', '😂', '😢', '😮'];
        reactions.forEach(r => {
            const option = document.createElement('div');
            option.textContent = r;
            option.onclick = () => addReaction(clubId, messageId, r);
            reactionSubmenu.appendChild(option);
        });
        reactionDiv.appendChild(reactionSubmenu);
        menuContent.appendChild(reactionDiv);
    }
}

function openThread(clubId, messageId) {
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!message) return;

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'thread-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Thread: ${sanitizeInput(message.text.slice(0, 30))}...</h3>
                <button class="neumorphic-btn" onclick="modalToggle('thread-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <div id="thread-messages"></div>
                <div class="thread-input">
                    <input type="text" id="thread-input-text" placeholder="Reply in thread...">
                    <button class="neumorphic-btn" onclick="sendThreadMessage('${sanitizeInput(clubId)}', '${sanitizeInput(messageId)}')">Send</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('thread-modal', false));

    renderThreadMessages(clubId, messageId);
}

function renderThreadMessages(clubId, messageId) {
    const threadMessagesEl = document.getElementById('thread-messages');
    if (!threadMessagesEl) return;

    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!message) return;

    message.thread = message.thread || [];
    const threadMessages = message.thread;

    threadMessagesEl.innerHTML = threadMessages.map((msg, i) => `
        <div class="thread-message">
            <span class="sender">${sanitizeInput(msg.sender)}</span>
            <p>${parseMentions(sanitizeInput(msg.text))}</p>
            <div class="timestamp">${formatTimestamp(msg.timestamp)}</div>
            ${msg.readBy?.length ? `<div class="read-receipt">Read by ${msg.readBy.length} user(s)</div>` : ''}
        </div>
    `).join('');
    threadMessagesEl.scrollTop = threadMessagesEl.scrollHeight;
}

function sendThreadMessage(clubId, messageId) {
    const input = document.getElementById('thread-input-text');
    const text = input.value.trim();
    if (!text) return;

    const threadMessage = {
        id: `thread-msg-${Date.now()}`,
        senderId: currentUserId,
        sender: currentUsername,
        text,
        timestamp: new Date().toISOString(),
        readBy: [{ id: currentUserId, username: currentUsername }]
    };

    safeExecute(async () => {
        const message = messageData[clubId]?.find(m => m.id === messageId);
        if (message) {
            message.thread = message.thread || [];
            message.thread.push(threadMessage);
            await apiRequest(`/api/clubs/${clubId}/messages/${messageId}/thread`, {
                method: 'POST',
                body: JSON.stringify(threadMessage)
            });
            localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
            if (isSocketInitialized) {
                socketIO.emit('threadMessage', { clubId, messageId, threadMessage });
            }
            renderThreadMessages(clubId, messageId);
            input.value = '';
            showNotification('Thread message sent.', 'success');
        }
    }, 'Failed to send thread message.');
}

if (isSocketInitialized) {
    socketIO.on('threadMessage', ({ clubId, messageId, threadMessage }) => {
        const message = messageData[clubId]?.find(m => m.id === messageId);
        if (message) {
            message.thread = message.thread || [];
            message.thread.push(threadMessage);
            localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
            if (document.getElementById('thread-modal') && clubId === localStorage.getItem('currentClubId')) {
                renderThreadMessages(clubId, messageId);
            }
        }
    });
}

function addThreadMenu(clubId, messageId) {
    const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
    if (!messageEl) return;

    const menuContent = messageEl.querySelector('.message-menu-content');
    if (menuContent) {
        const threadDiv = document.createElement('div');
        threadDiv.textContent = 'Open Thread';
        threadDiv.onclick = () => openThread(clubId, messageId);
        menuContent.appendChild(threadDiv);
    }
}

function addAttachment(clubId, messageId, file) {
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!message || !validateFile(file)) return;

    safeExecute(async () => {
        const formData = new FormData();
        formData.append('file', file);
        const response = await apiRequest(`/api/upload`, {
            method: 'POST',
            body: formData,
            headers: {}
        });
        message.attachments = message.attachments || [];
        message.attachments.push({ name: file.name, url: response.url, type: file.type });
        await apiRequest(`/api/clubs/${clubId}/messages/${messageId}`, {
            method: 'PATCH',
            body: JSON.stringify({ attachments: message.attachments })
        });
        localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
        if (isSocketInitialized) {
            socketIO.emit('attachment', { clubId, messageId, attachment: { name: file.name, url: response.url, type: file.type } });
        }
        renderChatMessages(clubId);
        showNotification('Attachment added!', 'success');
    }, 'Failed to add attachment.');
}

if (isSocketInitialized) {
    socketIO.on('attachment', ({ clubId, messageId, attachment }) => {
        const message = messageData[clubId]?.find(m => m.id === messageId);
        if (message) {
            message.attachments = message.attachments || [];
            message.attachments.push(attachment);
            localStorage.setItem(`chat_${clubId}`, JSON.stringify(messageData[clubId]));
            if (clubId === localStorage.getItem('currentClubId')) {
                renderChatMessages(clubId);
            }
        }
    });
}

function renderChatMessages(clubId, messages = null) {
    const messagesEl = document.getElementById('chat-messages');
    if (!messagesEl) return;

    messageData[clubId] = JSON.parse(localStorage.getItem(`chat_${clubId}`)) || [];
    const clubMessages = messages || messageData[clubId];
    if (clubMessages.length === 0) {
        messagesEl.innerHTML = `<p class="text-center">No messages yet.</p>`;
        return;
    }

    const pinnedMessages = clubMessages.filter(msg => msg.pinned);
    const regularMessages = clubMessages.filter(msg => !msg.pinned);
    const sortedMessages = [...pinnedMessages, ...regularMessages];

    messagesEl.innerHTML = sortedMessages.map((msg, i) => {
        const reactions = msg.reactions
            ? Object.entries(msg.reactions).map(([emoji, count]) => `${emoji} ${count}`).join(' ')
            : '';
        const readBy = msg.readBy?.length ? `Read by ${msg.readBy.length} user(s)` : '';
        const timestamp = msg.timestamp ? formatTimestamp(msg.timestamp) : '';
        const text = parseMentions(sanitizeInput(msg.text));
        const isEdited = msg.isEdited ? '<span class="edited-label">(edited)</span>' : '';
        const replyTo = msg.replyTo && messageData[clubId].find(m => m.id === msg.replyTo)
            ? `<div class="reply-preview" onclick="highlightMessage('${clubId}', '${msg.replyTo}')">
                <span>${sanitizeInput(messageData[clubId].find(m => m.id === msg.replyTo).sender)}:</span>
                ${sanitizeInput(messageData[clubId].find(m => m.id === msg.replyTo).text.slice(0, 50)) + '...'}
               </div>`
            : '';
        const categories = msg.categories?.length
            ? `<div class="message-categories">${msg.categories.map(c => `<span class="category">${sanitizeInput(c)}</span>`).join(' ')}</div>`
            : '';
        const attachments = msg.attachments?.length
            ? `<div class="attachments">${msg.attachments.map(a => `
                <a href="${sanitizeInput(a.url)}" download="${sanitizeInput(a.name)}">${sanitizeInput(a.name)}</a>
            `).join('')}</div>`
            : '';
        const threadCount = msg.thread?.length ? `<span class="thread-count" onclick="openThread('${clubId}', '${msg.id}')">Thread (${msg.thread.length})</span>` : '';
        const isBookmarked = userData.bookmarks?.some(b => b.clubId === clubId && b.messageId === msg.id);
        return `
            <div class="chat-message ${msg.senderId === currentUserId ? 'own' : ''} ${msg.pinned ? 'pinned' : ''} ${msg.isEdited ? 'edited' : ''} ${isBookmarked ? 'bookmarked' : ''}" data-message-id="${msg.id}" onclick="markMessageRead('${clubId}', '${msg.id}')">
                <span class="sender">${sanitizeInput(msg.sender)}</span>
                ${replyTo}
                <p>${text} ${isEdited}</p>
                ${msg.image ? `<img src="${sanitizeInput(msg.image)}" alt="Image" width="200">` : ''}
                ${msg.video ? `<video src="${sanitizeInput(msg.video)}" controls width="200"></video>` : ''}
                ${categories}
                ${attachments}
                ${reactions ? `<div class="reactions">${reactions}</div>` : ''}
                ${readBy ? `<div class="read-receipt">${readBy}</div>` : ''}
                ${timestamp ? `<div class="timestamp">${timestamp}</div>` : ''}
                ${threadCount}
                ${msg.pinned ? `<span class="pinned-icon"><i class="fas fa-thumbtack"></i></span>` : ''}
                ${isBookmarked ? `<span class="bookmark-icon"><i class="fas fa-bookmark"></i></span>` : ''}
                <span class="message-menu"><i class="fas fa-ellipsis-v"></i></span>
                <div class="message-menu-content">
                    ${msg.senderId === currentUserId ? `
                        <div onclick="openEditMessageModal('${clubId}', '${msg.id}')">Edit</div>
                        <div onclick="deleteMessage('${clubId}', '${msg.id}')">Delete</div>
                        <div onclick="replyToMessage('${clubId}', '${msg.id}')">Reply</div>
                        <div onclick="forwardMessage('${clubId}', '${msg.id}')">Forward</div>
                        ${msg.isEdited ? `<div onclick="viewEditHistory('${clubId}', '${msg.id}')">View Edit History</div>` : ''}
                    ` : `
                        <div onclick="replyToMessage('${clubId}', '${msg.id}')">Reply</div>
                    `}
                    <div onclick="bookmarkMessage('${clubId}', '${msg.id}')">${isBookmarked ? 'Remove Bookmark' : 'Bookmark'}</div>
                    <div onclick="openThread('${clubId}', '${msg.id}')">Open Thread</div>
                    ${(clubData.find(c => c.id === clubId)?.moderators.some(m => m.id === currentUserId) || clubData.find(c => c.id === clubId)?.creator.id === currentUserId) ? `
                        <div onclick="deleteMessageForAll('${clubId}', '${msg.id}')">Delete for All</div>
                        <div onclick="pinMessage('${clubId}', '${msg.id}')">${msg.pinned ? 'Unpin' : 'Pin'}</div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');

    document.querySelectorAll('.message-menu').forEach(menu => {
        menu.addEventListener('click', (e) => {
            e.stopPropagation();
            const menuContent = e.target.nextElementSibling;
            document.querySelectorAll('.message-menu-content.active').forEach(content => {
                if (content !== menuContent) content.classList.remove('active');
            });
            if (menuContent) menuContent.classList.toggle('active');
        });
    });

    messagesEl.scrollTop = messagesEl.scrollHeight;
    document.dispatchEvent(new Event('messagesRendered'));
}

document.addEventListener('messagesRendered', () => {
    const clubId = localStorage.getItem('currentClubId');
    messageData[clubId]?.forEach(msg => {
        addCategoryMenu(clubId, msg.id);
        addBookmarkMenu(clubId, msg.id);
        addReactionPicker(clubId, msg.id);
        addThreadMenu(clubId, msg.id);
    });
});

function cleanupModals() {
    document.querySelectorAll('.modal, .modal-overlay').forEach(el => el.remove());
}

window.addEventListener('beforeunload', cleanupModals);

document.querySelector('style').textContent += `
    .emoji-picker {
        position: absolute;
        bottom: 50px;
        background: var(--bg-color);
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    .emoji-picker span {
        font-size: 24px;
        margin: 5px;
        cursor: pointer;
    }
    .emoji-picker span:hover {
        background: var(--table-highlight);
        border-radius: 4px;
    }
    #typing-indicator {
        font-size: 12px;
        color: var(--text-muted);
        padding: 5px;
        position: absolute;
        bottom: 60px;
    }
    .category {
        background: var(--secondary-color);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        margin-right: 5px;
        font-size: 12px;
    }
    .submenu {
        display: none;
        position: absolute;
        background: var(--bg-color);
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-width: 100px;
        z-index: 1000;
    }
    .message-menu-content div:hover .submenu {
        display: block;
    }
    .submenu div {
        padding: 8px;
        cursor: pointer;
    }
    .submenu div:hover {
        background: var(--table-highlight);
    }
    .message-categories {
        margin-top: 5px;
    }
    .edited-label {
        font-size: 10px;
        color: var(--text-muted);
        margin-left: 5px;
    }
    .chat-message.edited p {
        position: relative;
    }
    .attachments {
        margin-top: 10px;
    }
    .attachments a {
        display: block;
        color: var(--accent-color);
        text-decoration: none;
    }
    .attachments a:hover {
        text-decoration: underline;
    }
    .bookmark-icon {
        position: absolute;
        top: 5px;
        right: 5px;
        color: var(--accent-color);
    }
    .chat-message.bookmarked {
        background: var(--table-highlight);
    }
    .thread-count {
        font-size: 12px;
        color: var(--accent-color);
        cursor: pointer;
        margin-top: 5px;
    }
    .thread-count:hover {
        text-decoration: underline;
    }
    .thread-message {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
    }
    .thread-input {
        display: flex;
        margin-top: 10px;
    }
    .thread-input input {
        flex: 1;
        margin-right: 10px;
    }
    .category-filter {
        margin-bottom: 10px;
        width: 200px;
    }
    .bookmark-item {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
    }
    .bookmark-item:hover {
        background: var(--table-highlight);
    }
`;

function addAttachmentMenu(clubId, messageId) {
    const messageEl = document.querySelector(`.chat-message[data-message-id="${sanitizeInput(messageId)}"]`);
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!messageEl || !message || message.senderId !== currentUserId) return;

    const menuContent = messageEl.querySelector('.message-menu-content');
    if (menuContent) {
        const attachmentDiv = document.createElement('div');
        attachmentDiv.textContent = 'Add Attachment';
        attachmentDiv.setAttribute('role', 'button');
        attachmentDiv.setAttribute('aria-label', 'Add Attachment');
        const input = document.createElement('input');
        input.type = 'file';
        input.style.display = 'none';
        input.onchange = (e) => {
            if (e.target.files[0]) {
                addAttachment(clubId, messageId, e.target.files[0]);
            }
        };
        attachmentDiv.onclick = () => input.click();
        menuContent.appendChild(attachmentDiv);
        menuContent.appendChild(input);
    }
}

document.addEventListener('messagesRendered', () => {
    const clubId = localStorage.getItem('currentClubId');
    messageData[clubId]?.forEach(msg => {
        addAttachmentMenu(clubId, msg.id);
        addReportMenu(clubId, msg.id);
    });
});

function reportMessage(clubId, messageId) {
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!message) return;

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'report-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Message</h3>
                <button class="neumorphic-btn" onclick="modalToggle('report-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="report-form">
                    <div class="form-group">
                        <label for="report-reason">Reason for Report</label>
                        <textarea id="report-reason" name="reason" required></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('report-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('report-modal', false));

    document.getElementById('report-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const reason = document.getElementById('report-reason').value.trim();

        await safeExecute(async () => {
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/messages/${sanitizeInput(messageId)}/report`, {
                method: 'POST',
                body: JSON.stringify({ reason, reporterId: currentUserId })
            });
            showNotification('Message reported successfully.', 'success');
            modalToggle('report-modal', false);
        }, 'Failed to report message.');
    });
}

function addReportMenu(clubId, messageId) {
    const messageEl = document.querySelector(`.chat-message[data-message-id="${sanitizeInput(messageId)}"]`);
    const message = messageData[clubId]?.find(m => m.id === messageId);
    if (!messageEl || !message || message.senderId === currentUserId) return;

    const menuContent = messageEl.querySelector('.message-menu-content');
    if (menuContent) {
        const reportDiv = document.createElement('div');
        reportDiv.textContent = 'Report';
        reportDiv.setAttribute('role', 'button');
        reportDiv.setAttribute('aria-label', 'Report Message');
        reportDiv.onclick = () => reportMessage(clubId, messageId);
        menuContent.appendChild(reportDiv);
    }
}

function manageRules() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to manage rules.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'rules-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Rules - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('rules-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-rule">Add New Rule</label>
                    <input type="text" id="new-rule" placeholder="Enter rule...">
                    <button class="neumorphic-btn" onclick="addRule('${sanitizeInput(clubId)}')">Add Rule</button>
                </div>
                <h4>Current Rules:</h4>
                <ul id="rule-list">
                    ${club.rules?.length ? club.rules.map((rule, index) => `
                        <li>
                            ${sanitizeInput(rule)}
                            <button class="neumorphic-btn error" onclick="removeRule('${sanitizeInput(clubId)}', ${index})">Remove</button>
                        </li>
                    `).join('') : '<p>No rules yet.</p>'}
                </ul>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('rules-modal', false));
}

function addRule(clubId) {
    const rule = document.getElementById('new-rule').value.trim();
    if (!rule) {
        showNotification('Rule cannot be empty.', 'error');
        return;
    }

    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.rules = club.rules || [];
    club.rules.push(rule);
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
            method: 'PATCH',
            body: JSON.stringify({ rules: club.rules })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('ruleUpdated', { clubId, rules: club.rules });
        }
        showNotification('Rule added successfully!', 'success');
        manageRules();
        updateClubInfo();
    }, 'Failed to add rule.');
}

function removeRule(clubId, ruleIndex) {
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    club.rules.splice(ruleIndex, 1);
    safeExecute(async () => {
        await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
            method: 'PATCH',
            body: JSON.stringify({ rules: club.rules })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('ruleUpdated', { clubId, rules: club.rules });
        }
        showNotification('Rule removed successfully!', 'success');
        manageRules();
        updateClubInfo();
    }, 'Failed to remove rule.');
}

if (isSocketInitialized) {
    socketIO.on('ruleUpdated', ({ clubId, rules }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club) {
            club.rules = rules;
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (clubId === localStorage.getItem('currentClubId')) {
                updateClubInfo();
            }
        }
    });
}

if (dropdownContent) {
    const rulesOption = document.createElement('div');
    rulesOption.textContent = 'Manage Rules';
    rulesOption.onclick = manageRules;
    rulesOption.setAttribute('role', 'button');
    rulesOption.setAttribute('aria-label', 'Manage Rules');
    dropdownContent.appendChild(rulesOption);
}

function inviteToClub() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club) return;

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'invite-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Invite to ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('invite-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="invite-form">
                    <div class="form-group">
                        <label for="invite-username">Username</label>
                        <input type="text" id="invite-username" name="username" required>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('invite-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Send Invite</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('invite-modal', false));

    document.getElementById('invite-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('invite-username').value.trim();

        await safeExecute(async () => {
            const user = await apiRequest(`/api/users?username=${encodeURIComponent(username)}`);
            if (!user || !user.id) {
                showNotification('User not found.', 'error');
                return;
            }
            if (club.members.some(m => m.id === user.id)) {
                showNotification('User is already a member.', 'error');
                return;
            }
            const existingInvite = await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/invites?userId=${user.id}`);
            if (existingInvite.length > 0) {
                showNotification('Invite already sent to this user.', 'error');
                return;
            }
            const invite = {
                id: `invite-${Date.now()}`,
                clubId,
                userId: user.id,
                senderId: currentUserId,
                senderUsername: currentUsername,
                timestamp: new Date().toISOString()
            };
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/invites`, {
                method: 'POST',
                body: JSON.stringify(invite)
            });
            if (isSocketInitialized) {
                socketIO.emit('clubInvite', { clubId, userId: user.id, invite });
            }
            showNotification(`Invite sent to ${sanitizeInput(username)}!`, 'success');
            modalToggle('invite-modal', false);
        }, 'Failed to send invite.');
    });
}

if (dropdownContent) {
    const inviteOption = document.createElement('div');
    inviteOption.textContent = 'Invite to Club';
    inviteOption.onclick = inviteToClub;
    inviteOption.setAttribute('role', 'button');
    inviteOption.setAttribute('aria-label', 'Invite to Club');
    dropdownContent.appendChild(inviteOption);
}

if (isSocketInitialized) {
    socketIO.on('clubInvite', ({ clubId, userId, invite }) => {
        if (userId === currentUserId) {
            const club = clubData.find(c => c.id === clubId);
            if (club && !club.muted) {
                showBrowserNotification('New Club Invite', `You have been invited to join ${sanitizeInput(club.name)} by ${sanitizeInput(invite.senderUsername)}!`);
            }
        }
    });
}

async function acceptInvite(inviteId) {
    await safeExecute(async () => {
        const invite = await apiRequest(`/api/invites/${sanitizeInput(inviteId)}`);
        if (!invite || invite.userId !== currentUserId) {
            showNotification('Invalid invite.', 'error');
            return;
        }
        const club = clubData.find(c => c.id === invite.clubId);
        if (!club) {
            showNotification('Club not found.', 'error');
            return;
        }
        if (club.members.some(m => m.id === currentUserId)) {
            showNotification('You are already a member.', 'error');
            return;
        }
        club.members.push({ id: currentUserId, username: currentUsername });
        await apiRequest(`/api/clubs/${sanitizeInput(invite.clubId)}`, {
            method: 'PATCH',
            body: JSON.stringify({ members: club.members })
        });
        await apiRequest(`/api/invites/${sanitizeInput(inviteId)}`, {
            method: 'DELETE'
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('joinClub', { clubId: invite.clubId, userId: currentUserId });
        }
        showNotification(`You have joined ${sanitizeInput(club.name)}!`, 'success');
        renderClub();
    }, 'Failed to accept invite.');
}

async function rejectInvite(inviteId) {
    await safeExecute(async () => {
        await apiRequest(`/api/invites/${sanitizeInput(inviteId)}`, {
            method: 'DELETE'
        });
        showNotification('Invite rejected.', 'success');
    }, 'Failed to reject invite.');
}

async function viewInvites() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'invites-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Club Invites</h3>
                <button class="neumorphic-btn" onclick="modalToggle('invites-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <div id="invite-list"></div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('invites-modal', false));

    await safeExecute(async () => {
        const invites = await apiRequest(`/api/invites?userId=${currentUserId}`);
        const inviteList = document.getElementById('invite-list');
        if (invites.length > 0) {
            inviteList.innerHTML = invites.map(invite => {
                const club = clubData.find(c => c.id === invite.clubId);
                return club ? `
                    <div class="invite-item">
                        <p><strong>${sanitizeInput(club.name)}</strong> invited you!</p>
                        <p>Sent by: ${sanitizeInput(invite.senderUsername)}</p>
                        <p>${formatTimestamp(invite.timestamp)}</p>
                        <button class="neumorphic-btn primary" onclick="acceptInvite('${sanitizeInput(invite.id)}')">Accept</button>
                        <button class="neumorphic-btn error" onclick="rejectInvite('${sanitizeInput(invite.id)}')">Reject</button>
                    </div>
                ` : '';
            }).join('');
        } else {
            inviteList.innerHTML = '<p>No pending invites.</p>';
        }
    }, 'Failed to load invites.');
}

if (dropdownContent) {
    const invitesOption = document.createElement('div');
    invitesOption.textContent = 'View Invites';
    invitesOption.onclick = viewInvites;
    invitesOption.setAttribute('role', 'button');
    invitesOption.setAttribute('aria-label', 'View Invites');
    dropdownContent.appendChild(invitesOption);
}

function createAnnouncement() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to create announcements.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'announcement-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Announcement - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('announcement-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="announcement-form">
                    <div class="form-group">
                        <label for="announcement-text">Announcement</label>
                        <textarea id="announcement-text" name="text" required></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('announcement-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Post</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('announcement-modal', false));

    document.getElementById('announcement-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = document.getElementById('announcement-text').value.trim();
        if (!text) {
            showNotification('Announcement cannot be empty.', 'error');
            return;
        }

        const announcement = {
            id: `announcement-${Date.now()}`,
            clubId,
            creatorId: currentUserId,
            creatorUsername: currentUsername,
            text,
            timestamp: new Date().toISOString()
        };

        await safeExecute(async () => {
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/announcements`, {
                method: 'POST',
                body: JSON.stringify(announcement)
            });
            club.announcements = club.announcements || [];
            club.announcements.push(announcement);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (isSocketInitialized) {
                socketIO.emit('announcement', { clubId, announcement });
            }
            showNotification('Announcement posted!', 'success');
            modalToggle('announcement-modal', false);
            displayAnnouncements(clubId);
        }, 'Failed to post announcement.');
    });
}

function displayAnnouncements(clubId) {
    const clubInfoSection = document.getElementById('club-info-section');
    if (!clubInfoSection) return;

    const existingAnnouncements = clubInfoSection.querySelector('.club-announcements');
    if (existingAnnouncements) existingAnnouncements.remove();

    safeExecute(async () => {
        const announcements = await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/announcements`);
        const announcementsDiv = document.createElement('div');
        announcementsDiv.className = 'club-announcements';
        announcementsDiv.innerHTML = '<h4>Announcements</h4>';
        if (announcements.length > 0) {
            announcementsDiv.innerHTML += announcements.map(ann => `
                <div class="announcement-item">
                    <p>${sanitizeInput(ann.text)}</p>
                    <p class="timestamp">${formatTimestamp(ann.timestamp)}</p>
                    <p>Posted by: ${sanitizeInput(ann.creatorUsername)}</p>
                </div>
            `).join('');
        } else {
            announcementsDiv.innerHTML += '<p>No announcements.</p>';
        }
        clubInfoSection.appendChild(announcementsDiv);
    }, 'Failed to load announcements.');
}

if (isSocketInitialized) {
    socketIO.on('announcement', ({ clubId, announcement }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club) {
            club.announcements = club.announcements || [];
            club.announcements.push(announcement);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (clubId === localStorage.getItem('currentClubId')) {
                displayAnnouncements(clubId);
            }
            if (!club.muted) {
                showBrowserNotification(`New Announcement in ${sanitizeInput(club.name)}`, sanitizeInput(announcement.text));
            }
        }
    });
}

if (dropdownContent) {
    const announcementOption = document.createElement('div');
    announcementOption.textContent = 'Create Announcement';
    announcementOption.onclick = createAnnouncement;
    announcementOption.setAttribute('role', 'button');
    announcementOption.setAttribute('aria-label', 'Create Announcement');
    dropdownContent.appendChild(announcementOption);
}

function manageMembers() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to manage members.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'members-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Members - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('members-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <h4>Members:</h4>
                <ul id="member-list"></ul>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('members-modal', false));

    safeExecute(async () => {
        const members = await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/members`);
        const memberList = document.getElementById('member-list');
        memberList.innerHTML = members.map(member => `
            <li>
                ${sanitizeInput(member.username)}
                ${member.id === club.creator.id ? ' (Creator)' : ''}
                ${club.moderators.some(m => m.id === member.id) ? ' (Moderator)' : ''}
                ${member.id !== club.creator.id ? `
                    <button class="neumorphic-btn error" onclick="openKickMemberModal('${sanitizeInput(clubId)}', '${sanitizeInput(member.id)}')">Kick</button>
                    ${club.moderators.some(m => m.id === member.id) ? `
                        <button class="neumorphic-btn" onclick="removeModerator('${sanitizeInput(clubId)}', '${sanitizeInput(member.id)}')">Remove Moderator</button>
                    ` : `
                        <button class="neumorphic-btn" onclick="addModerator('${sanitizeInput(clubId)}', '${sanitizeInput(member.id)}')">Make Moderator</button>
                    `}
                ` : ''}
            </li>
        `).join('');
    }, 'Failed to load members.');
}

function openKickMemberModal(clubId, userId) {
    const club = clubData.find(c => c.id === clubId);
    const member = club?.members.find(m => m.id === userId);
    if (!club || !member) return;

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'kick-member-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Kick</h3>
                <button class="neumorphic-btn" onclick="modalToggle('kick-member-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to kick ${sanitizeInput(member.username)} from ${sanitizeInput(club.name)}?</p>
                <div class="modal-buttons">
                    <button class="neumorphic-btn" onclick="modalToggle('kick-member-modal', false)">Cancel</button>
                    <button class="neumorphic-btn primary" onclick="kickMember('${sanitizeInput(clubId)}', '${sanitizeInput(userId)}')">Kick</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('kick-member-modal', false));
}

function kickMember(clubId, userId) {
    safeExecute(async () => {
        const club = clubData.find(c => c.id === clubId);
        club.members = club.members.filter(m => m.id !== userId);
        club.moderators = club.moderators.filter(m => m.id !== userId);
        await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
            method: 'PATCH',
            body: JSON.stringify({ members: club.members, moderators: club.moderators })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('memberKicked', { clubId, userId });
        }
        showNotification('Member kicked.', 'success');
        modalToggle('kick-member-modal', false);
        manageMembers();
    }, 'Failed to kick member.');
}

function addModerator(clubId, userId) {
    safeExecute(async () => {
        const club = clubData.find(c => c.id === clubId);
        const member = club.members.find(m => m.id === userId);
        if (member && !club.moderators.some(m => m.id === userId)) {
            club.moderators.push({ id: userId, username: member.username });
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
                method: 'PATCH',
                body: JSON.stringify({ moderators: club.moderators })
            });
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (isSocketInitialized) {
                socketIO.emit('moderatorToggled', { clubId, userId, action: 'add' });
            }
            showNotification('Member promoted to moderator.', 'success');
            manageMembers();
        }
    }, 'Failed to add moderator.');
}

function removeModerator(clubId, userId) {
    safeExecute(async () => {
        const club = clubData.find(c => c.id === clubId);
        club.moderators = club.moderators.filter(m => m.id !== userId);
        await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
            method: 'PATCH',
            body: JSON.stringify({ moderators: club.moderators })
        });
        localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
        if (isSocketInitialized) {
            socketIO.emit('moderatorToggled', { clubId, userId, action: 'remove' });
        }
        showNotification('Moderator status removed.', 'success');
        manageMembers();
    }, 'Failed to remove moderator.');
}

if (isSocketInitialized) {
    socketIO.on('memberKicked', ({ clubId, userId }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club && userId === currentUserId) {
            club.members = club.members.filter(m => m.id !== userId);
            club.moderators = club.moderators.filter(m => m.id !== userId);
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (clubId === localStorage.getItem('currentClubId')) {
                showNotification('You have been kicked from the club.', 'error');
                localStorage.removeItem('currentClubId');
                localStorage.removeItem(`chat_${clubId}`);
                renderClub();
            }
        }
    });

    socketIO.on('moderatorToggled', ({ clubId, userId, action }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club && userId === currentUserId) {
            showNotification(action === 'add' ? 'You have been promoted to moderator!' : 'Your moderator status has been removed.', 'success');
            if (clubId === localStorage.getItem('currentClubId')) {
                updateClubInfo();
            }
        }
    });
}

if (dropdownContent) {
    const membersOption = document.createElement('div');
    membersOption.textContent = 'Manage Members';
    membersOption.onclick = manageMembers;
    membersOption.setAttribute('role', 'button');
    membersOption.setAttribute('aria-label', 'Manage Members');
    dropdownContent.appendChild(membersOption);
}

function manageVisibility() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || club.creator.id !== currentUserId) {
        showNotification('Only the club creator can manage visibility.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'visibility-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Visibility - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('visibility-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="visibility-form">
                    <div class="form-group">
                        <label for="visibility">Club Visibility</label>
                        <select id="visibility" name="visibility">
                            <option value="public" ${club.visibility === 'public' ? 'selected' : ''}>Public</option>
                            <option value="private" ${club.visibility === 'private' ? 'selected' : ''}>Private</option>
                            <option value="hidden" ${club.visibility === 'hidden' ? 'selected' : ''}>Hidden</option>
                        </select>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('visibility-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('visibility-modal', false));

    document.getElementById('visibility-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const visibility = document.getElementById('visibility').value;

        await safeExecute(async () => {
            club.visibility = visibility;
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
                method: 'PATCH',
                body: JSON.stringify({ visibility })
            });
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (isSocketInitialized) {
                socketIO.emit('visibilityUpdated', { clubId, visibility });
            }
            showNotification('Visibility updated!', 'success');
            modalToggle('visibility-modal', false);
            updateClubInfo();
        }, 'Failed to update visibility.');
    });
}

if (isSocketInitialized) {
    socketIO.on('visibilityUpdated', ({ clubId, visibility }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club) {
            club.visibility = visibility;
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (clubId === localStorage.getItem('currentClubId')) {
                updateClubInfo();
            }
        }
    });
}

if (dropdownContent) {
    const visibilityOption = document.createElement('div');
    visibilityOption.textContent = 'Manage Visibility';
    visibilityOption.onclick = manageVisibility;
    visibilityOption.setAttribute('role', 'button');
    visibilityOption.setAttribute('aria-label', 'Manage Visibility');
    dropdownContent.appendChild(visibilityOption);
}

async function requestToJoinClub(clubId) {
    const club = clubData.find(c => c.id === clubId);
    if (!club || club.visibility !== 'private') {
        showNotification('This club is not private or does not exist.', 'error');
        return;
    }
    if (club.members.some(m => m.id === currentUserId)) {
        showNotification('You are already a member.', 'error');
        return;
    }
    const existingRequest = await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/join-requests?userId=${currentUserId}`);
    if (existingRequest.length > 0) {
        showNotification('You have already sent a join request.', 'error');
        return;
    }

    await safeExecute(async () => {
        const joinRequest = {
            id: `request-${Date.now()}`,
            clubId,
            userId: currentUserId,
            username: currentUsername,
            timestamp: new Date().toISOString()
        };
        await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/join-requests`, {
            method: 'POST',
            body: JSON.stringify(joinRequest)
        });
        if (isSocketInitialized) {
            socketIO.emit('joinRequest', { clubId, userId: currentUserId, joinRequest });
        }
        showNotification('Join request sent!', 'success');
    }, 'Failed to send join request.');
}

function manageJoinRequests() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to manage join requests.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'join-requests-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Join Requests - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('join-requests-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <div id="join-request-list"></div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('join-requests-modal', false));

    safeExecute(async () => {
        const requests = await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/join-requests`);
        const requestList = document.getElementById('join-request-list');
        if (requests.length > 0) {
            requestList.innerHTML = requests.map(req => `
                <div class="join-request-item">
                    <p><strong>${sanitizeInput(req.username)}</strong> requested to join.</p>
                    <p>${formatTimestamp(req.timestamp)}</p>
                    <button class="neumorphic-btn primary" onclick="acceptJoinRequest('${sanitizeInput(clubId)}', '${sanitizeInput(req.id)}')">Accept</button>
                    <button class="neumorphic-btn error" onclick="rejectJoinRequest('${sanitizeInput(clubId)}', '${sanitizeInput(req.id)}')">Reject</button>
                </div>
            `).join('');
        } else {
            requestList.innerHTML = '<p>No pending join requests.</p>';
        }
    }, 'Failed to load join requests.');
}

async function acceptJoinRequest(clubId, requestId) {
    await safeExecute(async () => {
        const request = await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/join-requests/${sanitizeInput(requestId)}`);
        if (!request) {
            showNotification('Invalid request.', 'error');
            return;
        }
        const club = clubData.find(c => c.id === clubId);
        if (!club) return;
        if (!club.members.some(m => m.id === request.userId)) {
            club.members.push({ id: request.userId, username: request.username });
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
                method: 'PATCH',
                body: JSON.stringify({ members: club.members })
            });
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/join-requests/${sanitizeInput(requestId)}`, {
                method: 'DELETE'
            });
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (isSocketInitialized) {
                socketIO.emit('joinClub', { clubId, userId: request.userId });
            }
            showNotification('Join request accepted.', 'success');
            manageJoinRequests();
        } else {
            showNotification('User is already a member.', 'error');
        }
    }, 'Failed to accept join request.');
}

async function rejectJoinRequest(clubId, requestId) {
    await safeExecute(async () => {
        await apiRequest(`/api/clubs/${sanitizeInput(clubId)}/join-requests/${sanitizeInput(requestId)}`, {
            method: 'DELETE'
        });
        showNotification('Join request rejected.', 'success');
        manageJoinRequests();
    }, 'Failed to reject join request.');
}

if (isSocketInitialized) {
    socketIO.on('joinRequest', ({ clubId, userId, joinRequest }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club && (club.moderators.some(m => m.id === currentUserId) || club.creator.id === currentUserId)) {
            if (!club.muted) {
                showBrowserNotification('New Join Request', `${sanitizeInput(joinRequest.username)} has requested to join ${sanitizeInput(club.name)}.`);
            }
        }
    });

    socketIO.on('joinClub', ({ clubId, userId }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club && userId === currentUserId && clubId === localStorage.getItem('currentClubId')) {
            updateClubInfo();
        }
    });
}

if (dropdownContent) {
    const joinRequestsOption = document.createElement('div');
    joinRequestsOption.textContent = 'Manage Join Requests';
    joinRequestsOption.onclick = manageJoinRequests;
    joinRequestsOption.setAttribute('role', 'button');
    joinRequestsOption.setAttribute('aria-label', 'Manage Join Requests');
    dropdownContent.appendChild(joinRequestsOption);
}

function searchClubs(query) {
    const filteredClubs = clubData.filter(club =>
        (club.visibility === 'public' || club.members.some(m => m.id === currentUserId)) &&
        (club.name.toLowerCase().includes(query.toLowerCase()) ||
         club.description?.toLowerCase().includes(query.toLowerCase()) ||
         club.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase())) ||
         club.categories?.some(category => category.toLowerCase().includes(query.toLowerCase())))
    );
    renderClub(filteredClubs);
}

function updateClubProfilePicture() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || club.creator.id !== currentUserId) {
        showNotification('Only the club creator can update the profile picture.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'club-profile-pic-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Club Profile Picture - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('club-profile-pic-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="club-profile-pic-form">
                    <div class="form-group">
                        <label for="club-profile-pic">Profile Picture</label>
                        <input type="file" id="club-profile-pic" name="club-profile-pic" accept="image/*">
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('club-profile-pic-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Update</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('club-profile-pic-modal', false));

    document.getElementById('club-profile-pic-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('club-profile-pic').files[0];
        if (!file || !validateFile(file)) {
            showNotification('Invalid file.', 'error');
            return;
        }

        await safeExecute(async () => {
            const formData = new FormData();
            formData.append('file', file);
            const response = await apiRequest(`/api/upload`, {
                method: 'POST',
                body: formData,
                headers: {}
            });
            club.image = response.url;
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
                method: 'PATCH',
                body: JSON.stringify({ image: club.image })
            });
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (isSocketInitialized) {
                socketIO.emit('clubProfileUpdated', { clubId, image: club.image });
            }
            showNotification('Club profile picture updated!', 'success');
            modalToggle('club-profile-pic-modal', false);
            updateClubInfo();
        }, 'Failed to update club profile picture.');
    });
}

if (isSocketInitialized) {
    socketIO.on('clubProfileUpdated', ({ clubId, image }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club) {
            club.image = image;
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (clubId === localStorage.getItem('currentClubId')) {
                updateClubInfo();
            }
        }
    });
}

if (dropdownContent) {
    const profilePicOption = document.createElement('div');
    profilePicOption.textContent = 'Update Club Profile Picture';
    profilePicOption.onclick = updateClubProfilePicture;
    profilePicOption.setAttribute('role', 'button');
    profilePicOption.setAttribute('aria-label', 'Update Club Profile Picture');
    dropdownContent.appendChild(profilePicOption);
}

function updateClubDescription() {
    const clubId = localStorage.getItem('currentClubId');
    const club = clubData.find(c => c.id === clubId);
    if (!club || (!club.moderators.some(m => m.id === currentUserId) && club.creator.id !== currentUserId)) {
        showNotification('You do not have permission to update the description.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'club-description-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Club Description - ${sanitizeInput(club.name)}</h3>
                <button class="neumorphic-btn" onclick="modalToggle('club-description-modal', false)">Close</button>
            </div>
            <div class="modal-body">
                <form id="club-description-form">
                    <div class="form-group">
                        <label for="club-description">Description</label>
                        <textarea id="club-description" name="description">${sanitizeInput(club.description || '')}</textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="neumorphic-btn" onclick="modalToggle('club-description-modal', false)">Cancel</button>
                        <button type="submit" class="neumorphic-btn primary">Update</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    document.body.appendChild(overlay);
    overlay.addEventListener('click', () => modalToggle('club-description-modal', false));

    document.getElementById('club-description-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const description = document.getElementById('club-description').value.trim();

        await safeExecute(async () => {
            club.description = description;
            await apiRequest(`/api/clubs/${sanitizeInput(clubId)}`, {
                method: 'PATCH',
                body: JSON.stringify({ description })
            });
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (isSocketInitialized) {
                socketIO.emit('clubDescriptionUpdated', { clubId, description });
            }
            showNotification('Club description updated!', 'success');
            modalToggle('club-description-modal', false);
            updateClubInfo();
        }, 'Failed to update club description.');
    });
}

if (isSocketInitialized) {
    socketIO.on('clubDescriptionUpdated', ({ clubId, description }) => {
        const club = clubData.find(c => c.id === clubId);
        if (club) {
            club.description = description;
            localStorage.setItem(`clubs_${currentUserId}`, JSON.stringify(clubData));
            if (clubId === localStorage.getItem('currentClubId')) {
                updateClubInfo();
            }
        }
    });
}

if (dropdownContent) {
    const descriptionOption = document.createElement('div');
    descriptionOption.textContent = 'Update Club Description';
    descriptionOption.onclick = updateClubDescription;
    descriptionOption.setAttribute('role', 'button');
    descriptionOption.setAttribute('aria-label', 'Update Club Description');
    dropdownContent.appendChild(descriptionOption);
}

if (localStorage.getItem('currentClubId')) {
    updateClubInfo();
    renderChatMessages(localStorage.getItem('currentClubId'));
    displayEvents(localStorage.getItem('currentClubId'));
    displayPolls(localStorage.getItem('currentClubId'));
    displayAnnouncements(localStorage.getItem('currentClubId'));
}

window.addEventListener('load', () => {
    processOfflineQueue();
    renderClub();
    updateCategoryFilter();
});

document.addEventListener('click', (e) => {
    if (!e.target.closest('.message-menu')) {
        document.querySelectorAll('.message-menu-content.active').forEach(menu => menu.classList.remove('active'));
    }
});

document.querySelector('style').textContent += `
    .club-rules {
        list-style-type: disc;
        margin-left: 20px;
        margin-top: 10px;
    }
    .club-rules li {
        margin-bottom: 5px;
    }
    .invite-item {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
    }
    .invite-item button {
        margin-right: 10px;
    }
    .club-announcements {
        margin-top: 20px;
    }
    .announcement-item {
        background: var(--table-highlight);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .announcement-item .timestamp {
        font-size: 12px;
        color: var(--text-muted);
    }
    #member-list li {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
    }
    #member-list button {
        margin-left: 10px;
    }
    .join-request-item {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
    }
    .join-request-item button {
        margin-right: 10px;
    }
`;
</script>
</body>
</html>
